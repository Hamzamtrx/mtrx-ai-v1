<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTRX AI — Facebook Ads</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════ */
    /* MTRX AI — Modern UI Design System (Inspired by Arcads/Parker)  */
    /* ═══════════════════════════════════════════════════════════════ */

    :root {
      /* Base colors — Deep dark theme (tryaiads style) */
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-card: rgba(18, 18, 22, 0.85);
      --bg-card-alt: rgba(12, 12, 15, 0.9);
      --bg-input: rgba(28, 28, 35, 0.8);
      --bg-elevated: rgba(32, 32, 40, 0.95);

      /* Borders — Subtle glass effect */
      --border-primary: rgba(255, 255, 255, 0.05);
      --border-secondary: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.12);
      --border-glow: rgba(168, 85, 247, 0.4);

      /* Text — Clean hierarchy */
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.85);
      --text-muted: rgba(255, 255, 255, 0.55);
      --text-dim: rgba(255, 255, 255, 0.35);
      --text-faint: rgba(255, 255, 255, 0.18);

      /* Accent — Purple to Pink gradient (tryaiads style) */
      --accent: #a855f7;
      --accent-secondary: #ec4899;
      --accent-hover: #c084fc;
      --accent-bg: rgba(168, 85, 247, 0.12);
      --accent-bg-strong: rgba(168, 85, 247, 0.18);
      --gradient-primary: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      --gradient-accent: linear-gradient(135deg, #8b5cf6, #a855f7);
      --gradient-pink: linear-gradient(135deg, #ec4899, #f472b6);
      --gradient-purple: linear-gradient(135deg, #7c3aed, #a855f7);

      /* Effects */
      --overlay: rgba(0, 0, 0, 0.9);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 40px rgba(168, 85, 247, 0.2);
      --shadow-accent: 0 4px 20px rgba(168, 85, 247, 0.35);
      --blur-sm: blur(8px);
      --blur-md: blur(16px);

      /* Spacing */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    [data-theme="light"] {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-card: rgba(255, 255, 255, 0.95);
      --bg-card-alt: rgba(249, 250, 251, 0.98);
      --bg-input: rgba(243, 244, 246, 0.9);
      --bg-elevated: rgba(255, 255, 255, 0.99);
      --border-primary: rgba(0, 0, 0, 0.06);
      --border-secondary: rgba(0, 0, 0, 0.1);
      --border-hover: rgba(0, 0, 0, 0.15);
      --text-primary: #09090b;
      --text-secondary: rgba(9, 9, 11, 0.85);
      --text-muted: rgba(9, 9, 11, 0.55);
      --text-dim: rgba(9, 9, 11, 0.4);
      --text-faint: rgba(9, 9, 11, 0.2);
      --accent: #9333ea;
      --accent-hover: #a855f7;
      --accent-bg: rgba(147, 51, 234, 0.1);
      --accent-bg-strong: rgba(147, 51, 234, 0.15);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.14);
      --shadow-accent: 0 4px 20px rgba(147, 51, 234, 0.25);
    }

    /* ═══════════ Base Styles ═══════════ */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(168, 85, 247, 0.08), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(236, 72, 153, 0.06), transparent);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ═══════════ Sidebar — Glass morphism ═══════════ */
    .sidebar {
      width: 240px;
      min-height: 100vh;
      background: var(--bg-card);
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      border-right: 1px solid var(--border-primary);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
    }

    .sidebar-logo {
      padding: 0 24px 32px;
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.5px;
    }
    .sidebar-logo span {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar-nav { flex: 1; padding: 0 12px; }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      margin-bottom: 4px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border-radius: var(--radius-md);
      border: 1px solid transparent;
    }
    .sidebar-item:hover {
      color: var(--text-primary);
      background: var(--accent-bg);
      border-color: var(--border-secondary);
    }
    .sidebar-item.active {
      color: var(--text-primary);
      background: var(--accent-bg-strong);
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
    }
    .sidebar-item svg {
      width: 18px;
      height: 18px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    .sidebar-item:hover svg,
    .sidebar-item.active svg { opacity: 1; }

    .sidebar-section {
      padding: 20px 16px 10px;
      font-size: 10px;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .sidebar-bottom {
      padding: 20px 16px;
      margin: 0 12px;
      border-top: 1px solid var(--border-primary);
    }
    .sidebar-brand { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    .sidebar-brand select {
      width: 100%;
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-secondary);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 13px;
      font-family: inherit;
      margin-top: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar-brand select:hover {
      border-color: var(--border-hover);
    }
    .sidebar-brand select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-bg);
    }

    /* Theme toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    .theme-toggle:hover { color: var(--text-primary); background: var(--bg-input); }
    .theme-switch {
      width: 40px;
      height: 22px;
      background: var(--bg-input);
      border: 1px solid var(--border-secondary);
      border-radius: 11px;
      position: relative;
      transition: all 0.3s ease;
    }
    .theme-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--text-primary);
      top: 2px;
      left: 3px;
      transition: transform 0.3s ease;
    }
    [data-theme="light"] .theme-switch {
      background: var(--gradient-accent);
      border-color: transparent;
    }
    [data-theme="light"] .theme-switch::after { transform: translateX(18px); }

    /* ═══════════ Main Content ═══════════ */
    .main {
      flex: 1;
      margin-left: 240px;
      padding: 40px 48px;
      min-height: 100vh;
    }

    .page-header {
      margin-bottom: 36px;
    }
    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .page-header p {
      color: var(--text-muted);
      font-size: 15px;
      line-height: 1.5;
    }

    /* ═══════════ Cards — Glass effect ═══════════ */
    .card {
      background: var(--bg-card);
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
      border: 1px solid var(--border-secondary);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-title {
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ═══════════ Buttons — Modern with gradients ═══════════ */
    .btn {
      padding: 12px 24px;
      border-radius: var(--radius-md);
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: var(--gradient-accent);
      color: #fff;
      box-shadow: 0 4px 16px rgba(6, 182, 212, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(6, 182, 212, 0.4);
    }
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-secondary);
    }
    .btn-secondary:hover {
      border-color: var(--border-hover);
      background: var(--bg-elevated);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }
    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ═══════════ Status Indicators ═══════════ */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      box-shadow: 0 0 8px currentColor;
    }
    .status-active { background: #22c55e; color: #22c55e; }
    .status-expired { background: #ef4444; color: #ef4444; }
    .status-disconnected { background: var(--text-dim); color: var(--text-dim); }

    /* ═══════════ Stats Grid ═══════════ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--bg-card);
      backdrop-filter: var(--blur-sm);
      border: 1px solid var(--border-secondary);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      font-weight: 500;
    }

    /* Classification badges */
    .cl-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .cl-badge svg { width: 12px; height: 12px; flex-shrink: 0; }
    .cl-winner { background: rgba(15,23,30,0.9); color: #4ade80; border: 1px solid rgba(34,197,94,0.5); }
    .cl-potential { background: rgba(15,23,30,0.9); color: #60a5fa; border: 1px solid rgba(59,130,246,0.5); }
    .cl-loser { background: rgba(15,23,30,0.9); color: #f87171; border: 1px solid rgba(239,68,68,0.4); }
    .cl-new { background: rgba(15,23,30,0.9); color: #c084fc; border: 1px solid rgba(168,85,247,0.5); }

    /* Classification stat cards */
    .stat-card.cl-stat { position: relative; overflow: hidden; }
    .stat-card.cl-stat::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .stat-card.cl-stat.winner::before { background: linear-gradient(90deg, #22c55e, #10b981); }
    .stat-card.cl-stat.potential::before { background: linear-gradient(90deg, #3b82f6, #6366f1); }
    .stat-card.cl-stat.new::before { background: linear-gradient(90deg, #a855f7, #8b5cf6); }
    .stat-card.cl-stat .stat-icon { position: absolute; top: 12px; right: 12px; opacity: 0.15; }
    .stat-card.cl-stat .stat-icon svg { width: 32px; height: 32px; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 12px; color: var(--text-dim); font-size: 11px; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid var(--border-primary); cursor: pointer; white-space: nowrap; }
    th:hover { color: var(--text-primary); }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border-primary); white-space: nowrap; }
    tr:hover td { background: var(--accent-bg); }
    .ad-name { max-width: 280px; overflow: hidden; text-overflow: ellipsis; }
    .ad-copy { max-width: 200px; overflow: hidden; text-overflow: ellipsis; color: var(--text-muted); font-size: 12px; }

    /* Filters */
    .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 24px; border: 1px solid var(--border-secondary); background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .filter-btn svg { width: 14px; height: 14px; opacity: 0.7; transition: opacity 0.2s; }
    .filter-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-card-alt); }
    .filter-btn:hover svg { opacity: 1; }
    .filter-btn.active { background: var(--accent-bg-strong); border-color: var(--accent); color: var(--accent); }
    .filter-btn.active svg { opacity: 1; }
    .filter-btn .filter-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 2px; }
    .filter-btn.active .filter-count { background: rgba(6,182,212,0.2); }
    .filter-btn[data-filter="winner"] { --filter-color: #22c55e; }
    .filter-btn[data-filter="winner"].active { background: rgba(34,197,94,0.15); border-color: #22c55e; color: #22c55e; }
    .filter-btn[data-filter="potential"] { --filter-color: #3b82f6; }
    .filter-btn[data-filter="potential"].active { background: rgba(59,130,246,0.15); border-color: #3b82f6; color: #3b82f6; }
    .filter-btn[data-filter="loser"] { --filter-color: #ef4444; }
    .filter-btn[data-filter="loser"].active { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #ef4444; }
    .filter-btn[data-filter="new"] { --filter-color: #a855f7; }
    .filter-btn[data-filter="new"].active { background: rgba(168,85,247,0.15); border-color: #a855f7; color: #a855f7; }

    /* Tabs */
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border-primary); margin-bottom: 24px; }
    .tab { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-dim); border-bottom: 2px solid transparent; transition: all 0.15s; }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Patterns */
    .pattern-bar { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
    .pattern-name { width: 120px; font-size: 12px; color: var(--text-muted); flex-shrink: 0; }
    .pattern-fill { height: 22px; border-radius: 4px; background: linear-gradient(90deg, #a855f7, #ec4899); min-width: 4px; transition: width 0.3s; }
    .pattern-val { font-size: 12px; color: var(--text-muted); min-width: 80px; }

    /* Strategic Insights */
    .insights-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .insights-header h3 { font-size: 16px; font-weight: 700; }
    .insights-header .insights-meta { font-size: 11px; color: var(--text-dim); }
    .insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .insights-grid { grid-template-columns: 1fr; } }
    .insight-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; transition: border-color 0.15s; }
    .insight-card:hover { border-color: var(--border-hover); }
    .insight-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .insight-card-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); }
    .insight-confidence { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; }
    .insight-confidence.high { background: rgba(34,197,94,0.15); color: #22c55e; }
    .insight-confidence.medium { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .insight-confidence.low { background: rgba(239,68,68,0.15); color: #ef4444; }
    .insight-summary { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; line-height: 1.4; }
    .insight-details { font-size: 13px; color: var(--text-secondary); line-height: 1.7; }
    .insight-details p { margin-bottom: 8px; }
    .insight-card.expanded .insight-details { display: block; }
    .insight-card .insight-details { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
    .insight-card.expanded .insight-details { display: block; -webkit-line-clamp: unset; }
    .insight-expand { background: none; border: none; color: var(--accent); font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 0; margin-top: 6px; font-family: inherit; }
    .insight-expand:hover { text-decoration: underline; }
    .insights-loading { text-align: center; padding: 60px 20px; }
    .insights-loading .spinner { width: 32px; height: 32px; }
    .insights-loading p { color: var(--text-dim); font-size: 13px; margin-top: 12px; }
    .insights-loading .subtext { font-size: 11px; color: var(--text-faint); margin-top: 4px; }

    /* Sync Status Banner */
    .sync-banner { display: none; align-items: center; gap: 12px; background: var(--accent-bg-strong); border: 1px solid var(--accent); border-radius: 10px; padding: 12px 20px; margin-bottom: 16px; }
    .sync-banner.active { display: flex; }
    .sync-banner .sync-spinner { width: 18px; height: 18px; border: 2px solid rgba(6,182,212,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
    .sync-banner .sync-text { font-size: 13px; color: var(--text-primary); flex: 1; }
    .sync-banner .sync-step { font-size: 11px; color: var(--text-muted); }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-dim); }
    .spinner { display: inline-block; width: 24px; height: 24px; border: 2px solid var(--border-secondary); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state h2 { margin-bottom: 8px; font-size: 20px; }
    .empty-state p { color: var(--text-dim); margin-bottom: 24px; font-size: 14px; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-card); border: 1px solid var(--border-secondary); border-radius: 10px; padding: 14px 20px; font-size: 13px; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { border-color: #ef4444; }
    .toast.success { border-color: #22c55e; }

    /* Two col */
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 1000px) { .two-col { grid-template-columns: 1fr; } }

    /* Connection card */
    .connection-bar { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .connection-bar span { font-size: 13px; }

    /* ═══════════════════════════════════════════ */
    /* Ad Card Grid                               */
    /* ═══════════════════════════════════════════ */
    .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .ad-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; overflow: hidden; cursor: pointer; transition: border-color 0.15s, transform 0.15s; }
    .ad-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
    .ad-card-image { width: 100%; height: 180px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .ad-card-image img { width: 100%; height: 100%; object-fit: cover; }
    .ad-card-image .placeholder-img { color: var(--text-faint); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .ad-card-badge { position: absolute; top: 8px; left: 8px; }
    .ad-card-body { padding: 14px; }
    .ad-card-name { font-size: 13px; font-weight: 600; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ad-card-metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .ad-card-metric { text-align: center; }
    .ad-card-metric .val { font-size: 14px; font-weight: 700; }
    .ad-card-metric .lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
    .ad-card-copy { font-size: 12px; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* View toggle */
    .view-toggle { display: flex; gap: 4px; background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 8px; padding: 3px; }
    .view-toggle button { background: none; border: none; color: var(--text-dim); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .view-toggle button.active { background: var(--bg-input); color: var(--text-primary); }

    /* ═══════════════════════════════════════════ */
    /* Ad Detail Overlay                          */
    /* ═══════════════════════════════════════════ */
    .ad-detail-overlay { position: fixed; inset: 0; background: var(--overlay); z-index: 500; display: none; align-items: center; justify-content: center; padding: 32px; }
    .ad-detail-overlay.show { display: flex; }
    .ad-detail-panel { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
    .ad-detail-close { position: absolute; top: 16px; right: 16px; background: var(--bg-input); border: 1px solid var(--border-hover); color: var(--text-primary); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10; }
    .ad-detail-close:hover { background: var(--border-secondary); }
    .ad-detail-image { width: 100%; max-height: 360px; object-fit: contain; background: var(--bg-primary); border-radius: 16px 16px 0 0; }
    .ad-detail-video-container { position: relative; width: 100%; background: #000; border-radius: 16px 16px 0 0; overflow: hidden; min-height: 200px; }
    .ad-detail-video { width: 100%; max-height: 450px; border-radius: 16px 16px 0 0; }
    .video-play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); cursor: pointer; transition: background 0.2s; }
    .video-play-overlay:hover { background: rgba(0,0,0,0.5); }
    .video-play-overlay svg { filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5)); transition: transform 0.2s; }
    .video-play-overlay:hover svg { transform: scale(1.1); }
    .video-loading { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); color: #fff; gap: 12px; font-size: 13px; }

    /* Generation Progress */
    .gen-progress { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 10px; padding: 12px; }
    .gen-progress-items { display: flex; flex-direction: column; gap: 8px; }
    .gen-progress-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-primary); border-radius: 8px; }
    .gen-progress-item .progress-icon { width: 20px; height: 20px; flex-shrink: 0; }
    .gen-progress-item .progress-icon.loading { border: 2px solid var(--border-secondary); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    .gen-progress-item .progress-icon.done { color: #22c55e; }
    .gen-progress-item .progress-icon.error { color: #ef4444; }
    .gen-progress-item .progress-label { flex: 1; font-size: 12px; font-weight: 500; }
    .gen-progress-item .progress-status { font-size: 11px; color: var(--text-dim); }
    .gen-progress-item.active { background: var(--accent-bg); border: 1px solid var(--accent); }
    .gen-progress-item .preview-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }

    /* Video Lightbox - fullscreen */
    .video-lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .video-lightbox-close { position: absolute; top: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10; }
    .video-lightbox-close:hover { background: rgba(255,255,255,0.2); }
    .video-lightbox-iframe { width: 394px; height: 700px; border: none; border-radius: 12px; background: #000; }
    .ad-detail-content { padding: 24px; }
    .ad-detail-content h2 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .ad-detail-content .detail-headline { font-size: 14px; color: var(--accent); margin-bottom: 16px; }
    .ad-detail-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .ad-detail-metrics .dm { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 8px; padding: 12px; text-align: center; }
    .ad-detail-metrics .dm .v { font-size: 18px; font-weight: 700; }
    .ad-detail-metrics .dm .l { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }
    .ad-detail-copy { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 10px; padding: 16px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; }

    /* Comments */
    .comments-section { margin-top: 20px; }
    .comments-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
    .comments-list { display: flex; flex-direction: column; gap: 10px; }
    .comment-item { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 10px; padding: 12px 16px; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .comment-author { font-size: 12px; font-weight: 600; color: var(--accent); }
    .comment-date { font-size: 11px; color: var(--text-faint); }
    .comment-body { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .comment-likes { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
    .comments-loading { text-align: center; padding: 20px; color: var(--text-dim); font-size: 12px; }
    .comments-error { text-align: center; padding: 16px; color: var(--text-dim); font-size: 12px; background: var(--bg-card-alt); border-radius: 8px; }

    /* Transcript */
    .transcript-section { margin-bottom: 20px; }
    .transcript-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
    .transcript-content { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 10px; padding: 16px; font-size: 13px; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; }
    .transcript-btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; }
    .transcript-btn:hover { border-color: var(--accent); color: var(--accent); }
    .transcript-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .transcript-btn svg { width: 14px; height: 14px; }
    .video-description-content { background: var(--bg-card-alt); border: 1px solid var(--border-primary); border-radius: 10px; padding: 16px; font-size: 13px; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; }
    .video-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: #fff; border-radius: 4px; padding: 2px 6px; font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .video-badge svg { width: 12px; height: 12px; }

    /* ═══════════════════════════════════════════ */
    /* Generate Statics Tab                       */
    /* ═══════════════════════════════════════════ */
    .gen-step {
      background: var(--bg-card);
      backdrop-filter: var(--blur-sm);
      border: 1px solid var(--border-secondary);
      border-radius: var(--radius-xl);
      padding: 28px;
      margin-bottom: 24px;
    }
    .gen-step h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .gen-step h3 .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--gradient-accent);
      color: #fff;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .test-suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    /* ═══════════════════════════════════════════ */
    /* Test Card V2 — Modern, Clean Design        */
    /* ═══════════════════════════════════════════ */
    .test-card-v2 {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.2s ease;
      position: relative;
    }
    .test-card-v2:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(6, 182, 212, 0.15);
      transform: translateY(-2px);
    }

    /* Gradient accent bar at top */
    .test-card-accent {
      height: 4px;
      width: 100%;
    }
    .test-card-accent.new {
      background: linear-gradient(90deg, #a855f7, #ec4899);
    }
    .test-card-accent.iter {
      background: linear-gradient(90deg, #8b5cf6, #a855f7);
    }

    /* Card body */
    .test-card-body {
      padding: 20px;
    }

    /* Badges */
    .test-card-badges {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .test-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-new {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }
    .badge-iter {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }
    .badge-reddit {
      background: rgba(255, 87, 34, 0.15);
      color: #ff7043;
    }
    .badge-trend {
      background: rgba(236, 72, 153, 0.15);
      color: #f472b6;
    }
    .badge-fb {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    /* Hook — the star of the card */
    .test-card-hook {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
      margin-bottom: 8px;
      text-align: center;
      padding: 16px;
      background: var(--bg-input);
      border-radius: 12px;
      border: 1px solid var(--border-primary);
    }

    /* Title */
    .test-card-title {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 16px;
    }

    /* Learning text */
    .test-card-learning {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-card-alt);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }

    /* Confidence meters */
    .test-card-meters {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-bottom: 16px;
    }
    .meter {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .meter-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .meter-dots {
      font-size: 12px;
      letter-spacing: 2px;
    }
    .meter-dots.high { color: #22c55e; }
    .meter-dots.medium { color: #f59e0b; }
    .meter-dots.low { color: #ef4444; }

    /* Format pills */
    .test-card-formats {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .format-pill {
      font-size: 10px;
      padding: 4px 10px;
      background: var(--bg-input);
      border: 1px solid var(--border-secondary);
      border-radius: 20px;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    /* Generate button */
    .test-card-btn {
      width: 100%;
      padding: 12px 20px;
      background: linear-gradient(135deg, #a855f7, #ec4899);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      font-family: inherit;
    }
    .test-card-btn:hover {
      background: linear-gradient(135deg, #9333ea, #db2777);
      transform: scale(1.02);
    }
    .test-card-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Expandable details section */
    .test-card-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: var(--bg-card-alt);
      border-top: 1px solid var(--border-primary);
    }
    .test-card-details.expanded {
      max-height: 500px;
      padding: 16px 20px;
    }
    .detail-row {
      margin-bottom: 12px;
    }
    .detail-row:last-child {
      margin-bottom: 0;
    }
    .detail-label {
      font-size: 10px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .detail-value {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      display: block;
    }

    /* Expand toggle button */
    .test-card-expand {
      width: 100%;
      padding: 10px;
      background: var(--bg-card-alt);
      border: none;
      border-top: 1px solid var(--border-primary);
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      font-family: inherit;
    }
    .test-card-expand:hover {
      background: var(--bg-input);
      color: var(--text-muted);
    }
    .test-card-expand svg {
      transition: transform 0.2s;
    }

    /* Selected state for v2 cards */
    .test-card-v2.selected {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 2px var(--accent), 0 8px 32px rgba(6, 182, 212, 0.2) !important;
    }
    .test-card-v2.selected .test-card-accent {
      height: 6px;
    }

    /* Source Filter Tabs */
    .source-filter-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .source-filter-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-secondary);
      border-radius: 20px;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .source-filter-btn:hover {
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    .source-filter-btn.active {
      background: var(--accent-bg-strong);
      border-color: var(--accent);
      color: var(--accent);
    }
    .source-filter-btn .filter-icon {
      font-size: 14px;
    }

    /* Collapsible Section */
    .collapsible-section {
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      overflow: hidden;
    }
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-card-alt);
      cursor: pointer;
      transition: background 0.15s;
    }
    .collapsible-header:hover {
      background: var(--bg-input);
    }
    .collapsible-content {
      padding: 0;
      transition: all 0.3s ease;
    }
    .collapsible-content.expanded {
      padding: 20px;
    }
    .collapsible-section.expanded .collapsible-header {
      border-bottom: 1px solid var(--border-primary);
    }

    /* Legacy styles for backwards compat */
    .test-card-clean.selected { border-color: #17a2b8 !important; box-shadow: 0 2px 8px rgba(23,162,184,0.2) !important; background: #f8fdfe !important; }
    .test-card-clean.selected::before { content: '✓'; position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; background: #17a2b8; color: #fff; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; }
    .test-card-clean { position: relative; }
    /* Legacy styles for backwards compat */
    .test-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.15s; position: relative; }
    .test-card:hover { border-color: var(--accent); transform: translateY(-1px); }
    .test-card.selected { border-color: var(--accent); background: var(--accent-bg); }
    .test-card .test-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .test-card .test-priority { display: inline-block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; font-weight: 600; }
    .test-card .test-priority.high { background: rgba(239,68,68,0.15); color: #ef4444; }
    .test-card .test-priority.medium { background: rgba(234,179,8,0.15); color: #eab308; }
    .test-card .test-priority.low { background: rgba(34,197,94,0.15); color: #22c55e; }
    .test-card .test-angle { font-size: 12px; color: var(--accent); margin-bottom: 6px; font-weight: 500; }
    .test-card .test-hook { font-size: 12px; color: var(--text-secondary); font-style: italic; margin-bottom: 8px; line-height: 1.4; }
    .test-card .test-copy-dir { font-size: 12px; color: var(--text-muted); line-height: 1.4; margin-bottom: 8px; }
    .test-card .test-meta { font-size: 11px; color: var(--text-dim); border-top: 1px solid var(--border-primary); padding-top: 8px; margin-top: 8px; }
    .test-card .test-meta span { margin-right: 12px; }

    /* Setup panel (matching Image Generator) */
    .setup-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 24px; }
    @media (max-width: 900px) { .setup-panel { grid-template-columns: 1fr; } }
    .type-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .type-grid.static-grid { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 700px) { .type-grid.static-grid { grid-template-columns: repeat(2, 1fr); } }
    .type-btn { background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; padding: 12px; color: var(--text-muted); font-size: 12px; cursor: pointer; text-align: left; transition: all 0.15s; font-family: inherit; }
    .type-btn:hover { border-color: var(--text-dim); color: var(--text-primary); }
    .type-btn.selected { background: rgba(6,182,212,0.1); border-color: var(--accent); color: var(--accent); }
    .type-btn .name { font-weight: 600; display: block; }
    .type-btn .desc { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
    .type-btn.selected .desc { color: rgba(6,182,212,0.6); }

    /* Variant selector buttons */
    .gen-var-btn { padding: 8px 16px; background: var(--bg-input); border: 1px solid var(--border-hover); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; transition: all 0.15s; }
    .gen-var-btn.selected { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* Upload box */
    .upload-box { border: 2px dashed var(--border-hover); border-radius: 10px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.15s; }
    .upload-box:hover { border-color: var(--accent); }
    .upload-box.has-file { border-style: solid; border-color: var(--accent); padding: 16px; }
    .upload-box h3 { font-size: 13px; margin-bottom: 4px; }
    .upload-box p { color: var(--text-dim); font-size: 11px; }

    /* URL input */
    .url-input { margin-top: 12px; }
    .url-input input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 13px; outline: none; font-family: inherit; }
    .url-input input:focus { border-color: var(--accent); }

    /* Launch button */
    .launch-btn { width: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border: none; border-radius: 10px; padding: 14px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
    .launch-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .launch-btn .count { background: rgba(0,0,0,0.2); padding: 3px 10px; border-radius: 10px; font-size: 12px; }
    .static-launch { background: linear-gradient(90deg, #8b5cf6, #ec4899); }

    /* Campaign status bar */
    .campaign-status { display: none; margin-bottom: 24px; }
    .campaign-status.active { display: flex; align-items: center; justify-content: space-between; }
    .status-left { display: flex; align-items: center; gap: 16px; }
    .status-label { color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
    .status-count { font-size: 14px; font-weight: 600; }
    .progress-bar { width: 200px; height: 4px; background: var(--border-secondary); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
    .download-all { background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; padding: 8px 16px; color: var(--text-muted); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-family: inherit; }
    .download-all:hover { border-color: var(--accent); color: var(--text-primary); }

    /* Image grid (results) */
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; min-height: 50px; }
    .image-card { background: var(--bg-card); border: 1px solid var(--border-secondary); border-radius: 10px; overflow: hidden; transition: all 0.2s; min-height: 280px; }
    .image-card.forging { border-color: var(--accent); }
    .image-card.error { border-color: #ef4444; background: rgba(239,68,68,0.1); }
    .image-placeholder { aspect-ratio: 1; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .status-text { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .status-text.queue { color: var(--text-dim); }
    .status-text.forging { color: var(--accent); }
    .image-card img { width: 100%; aspect-ratio: 4/5; object-fit: contain; display: block; background: var(--bg-primary); }
    .image-card .info { padding: 12px; }
    .image-card .direction { font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 4px; }
    .image-card .type-badge { color: #7f78c5; font-size: 11px; font-weight: 500; }
    .image-card .error-msg { color: #ef4444; font-size: 11px; margin-top: 8px; }
    .image-card .actions { display: flex; gap: 6px; margin-top: 10px; }
    .image-card .actions a, .image-card .actions button { flex: 1; text-align: center; padding: 10px 8px; font-size: 11px; font-weight: 600; border-radius: 8px; text-decoration: none; cursor: pointer; transition: all 0.15s; font-family: inherit; border: none; }
    .view-btn { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-hover) !important; }
    .view-btn:hover { border-color: #7f78c5 !important; }
    .download-btn { background: #7f78c5; color: #fff; }
    .download-btn:hover { background: #6b64b0; }

    /* Onboarding Modal */
    .modal-overlay { position: fixed; inset: 0; background: var(--overlay); z-index: 600; display: none; align-items: center; justify-content: center; padding: 32px; }
    .modal-overlay.show { display: flex; }
    .modal-panel { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; max-width: 480px; width: 100%; padding: 32px; position: relative; }
    .modal-panel h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .modal-panel .modal-subtitle { color: var(--text-dim); font-size: 13px; margin-bottom: 24px; }
    .modal-panel label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; margin-top: 16px; }
    .modal-panel input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 13px; outline: none; font-family: inherit; }
    .modal-panel input:focus { border-color: var(--accent); }
    .modal-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px; }
    .modal-cat-btn { background: var(--bg-input); border: 1px solid var(--border-hover); border-radius: 8px; padding: 14px 12px; color: var(--text-muted); font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; text-align: center; }
    .modal-cat-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
    .modal-cat-btn.selected { background: var(--accent-bg-strong); border-color: var(--accent); color: var(--accent); }
    .modal-cat-btn .cat-icon { font-size: 24px; display: block; margin-bottom: 4px; }
    .modal-actions { display: flex; gap: 8px; margin-top: 24px; }
    .modal-actions .btn { flex: 1; }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { width: 60px; }
      .sidebar-item span, .sidebar-section, .sidebar-logo span, .sidebar-bottom { display: none; }
      .sidebar-item { justify-content: center; padding: 12px; }
      .main { margin-left: 60px; padding: 20px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .ads-grid { grid-template-columns: 1fr; }
      .gen-form { grid-template-columns: 1fr; }
      .ad-detail-overlay { padding: 12px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="url(#g)"/><defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#a855f7"/><stop offset="1" stop-color="#ec4899"/></linearGradient></defs><path d="M7 8h10M7 12h7M7 16h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
      <span>MTRX AI</span>
    </div>

    <div class="sidebar-nav">
      <a href="/" class="sidebar-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <span>Image Generator</span>
      </a>

      <div class="sidebar-section">Facebook Ads</div>

      <a href="/facebook" class="sidebar-item active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
        <span>Dashboard</span>
      </a>
      <a href="/facebook" class="sidebar-item" onclick="switchTab('ads'); return false;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <span>Ad Performance</span>
      </a>
      <a href="/facebook" class="sidebar-item" onclick="switchTab('patterns'); return false;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <span>Strategic Insights</span>
      </a>
      <a href="/facebook" class="sidebar-item" onclick="switchTab('generate'); return false;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span>Generate Statics</span>
      </a>
      <a href="/facebook" class="sidebar-item" onclick="switchTab('campaigns'); return false;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><path d="M9 5a2 2 0 002 2h2a2 2 0 002-2"/><path d="M9 14l2 2 4-4"/></svg>
        <span>Campaigns</span>
      </a>
    </div>

    <div class="sidebar-bottom">
      <div class="theme-toggle" onclick="toggleTheme()">
        <div class="theme-switch"></div>
        <span id="themeLabel">Light mode</span>
      </div>
      <div class="sidebar-brand" style="margin-top:12px;">
        <div style="font-size:10px;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Brand</div>
        <div style="display:flex;gap:4px;align-items:center;">
          <select id="brandSelect" onchange="switchBrand()" style="flex:1;">
            <option value="">Select brand...</option>
          </select>
          <button id="brandSettingsBtn" class="btn btn-secondary btn-sm" style="padding:4px 6px;font-size:13px;line-height:1;display:none;" onclick="openBrandSettings()" title="Brand Settings">&#9881;</button>
        </div>
        <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:6px;padding:5px;font-size:11px;" onclick="showNewBrandModal()">+ New Brand</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main">
    <!-- Connection Status -->
    <div id="connectionCard" class="card" style="display:none;">
      <div class="card-header">
        <span class="card-title">Facebook Connection</span>
        <div id="connectionActions"></div>
      </div>
      <div id="connectionStatus"></div>
    </div>

    <!-- Not Connected State -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" style="margin-bottom:16px;"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>
      <h2>Connect Your Facebook Ad Account</h2>
      <p>Link your Facebook ad account to analyze performance, find winning patterns, and generate AI creative briefs.</p>
      <button class="btn btn-primary" onclick="connectFacebook()">Connect Facebook</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none;">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <h1>Ad Performance Intelligence</h1>
          <p>Analyze your Facebook ads, find winning patterns, and generate AI-powered insights.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <label style="font-size:11px;color:var(--text-dim);white-space:nowrap;">Time Frame:</label>
          <select id="datePresetSelect" onchange="changeDatePreset()" style="background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border-hover);border-radius:6px;padding:6px 10px;font-size:12px;font-family:inherit;">
            <option value="last_30d">Last 30 Days</option>
            <option value="last_90d" selected>Last 90 Days</option>
            <option value="lifetime">Lifetime</option>
          </select>
        </div>
      </div>

      <div id="statsGrid" class="stats-grid"></div>

      <!-- Sync Status Banner -->
      <div id="syncBanner" class="sync-banner">
        <div class="sync-spinner"></div>
        <div>
          <div class="sync-text" id="syncText">Syncing data from Facebook...</div>
          <div class="sync-step" id="syncStep"></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="ads" onclick="switchTab('ads')">Ads</div>
        <div class="tab" data-tab="patterns" onclick="switchTab('patterns')">Strategic Insights</div>
        <div class="tab" data-tab="generate" onclick="switchTab('generate')">Generate Statics</div>
        <div class="tab" data-tab="campaigns" onclick="switchTab('campaigns')">
          Campaigns
          <span id="campaignCount" style="background:#28a745;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;display:none;">0</span>
        </div>
      </div>

      <!-- Ads Tab -->
      <div id="tab-ads" class="tab-content active">
        <div class="card-header">
          <div class="filters" id="classificationFilters">
            <button class="filter-btn active" data-filter="all" onclick="filterAds('all')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              All
            </button>
            <button class="filter-btn" data-filter="winner" onclick="filterAds('winner')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              Winners
              <span class="filter-count" id="filterCountWinner"></span>
            </button>
            <button class="filter-btn" data-filter="potential" onclick="filterAds('potential')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>
              Potential
              <span class="filter-count" id="filterCountPotential"></span>
            </button>
            <button class="filter-btn" data-filter="new" onclick="filterAds('new')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
              New
              <span class="filter-count" id="filterCountNew"></span>
            </button>
            <button class="filter-btn" data-filter="loser" onclick="filterAds('loser')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/></svg>
              Losers
              <span class="filter-count" id="filterCountLoser"></span>
            </button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="view-toggle">
              <button class="active" data-view="grid" onclick="setView('grid')">Grid</button>
              <button data-view="table" onclick="setView('table')">Table</button>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="syncData()">Sync Data</button>
            <button class="btn btn-secondary btn-sm" onclick="reclassify()">Re-classify</button>
          </div>
        </div>

        <!-- Grid View -->
        <div id="adsGridView" class="ads-grid"></div>

        <!-- Table View -->
        <div id="adsTableView" class="table-wrap" style="display:none;">
          <table>
            <thead>
              <tr>
                <th onclick="sortAds('ad_name')">Ad Name</th>
                <th onclick="sortAds('classification')">Status</th>
                <th onclick="sortAds('spend')">Spend</th>
                <th onclick="sortAds('purchases')">Purchases</th>
                <th onclick="sortAds('cpa')">CPA</th>
                <th onclick="sortAds('roas')">ROAS</th>
                <th onclick="sortAds('ctr')">CTR</th>
                <th onclick="sortAds('impressions')">Impressions</th>
                <th>Copy</th>
              </tr>
            </thead>
            <tbody id="adsTableBody"></tbody>
          </table>
        </div>

        <div id="adsLoading" class="loading" style="display:none;"><div class="spinner"></div><br>Loading ads...</div>
        <div id="adsPagination" style="text-align:center;padding:16px;"></div>
      </div>

      <!-- Strategic Insights Tab -->
      <div id="tab-patterns" class="tab-content">
        <div class="insights-header">
          <div>
            <h3>Strategic Analysis</h3>
            <p style="color:var(--text-dim);font-size:12px;margin-top:2px;">AI-powered analysis of your ad performance data</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <span id="insightsTimestamp" class="insights-meta"></span>
            <button class="btn btn-primary btn-sm" onclick="runStrategicAnalysis()" id="runInsightsBtn">Analyze with AI</button>
          </div>
        </div>
        <div id="insightsContent"></div>
        <div id="insightsLoading" class="insights-loading" style="display:none;">
          <div class="spinner"></div>
          <p>Claude is analyzing your top ads...</p>
          <div class="subtext">Fetching comments, examining winning ads, transcripts, visuals, and creative patterns</div>
        </div>
      </div>

      <!-- Generate Statics Tab -->
      <div id="tab-generate" class="tab-content">
        <!-- Step 1: AI Test Suggestions -->
        <div class="gen-step">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin-bottom:0;"><span class="step-num">1</span> Test Suggestions</h3>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-secondary btn-sm" onclick="refreshTestSuggestions()" id="refreshTestsBtn" title="Force fresh generation (ignores cache)">
                <svg style="width:14px;height:14px;margin-right:4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
              <button class="btn btn-primary btn-sm" onclick="loadTestSuggestions()" id="loadTestsBtn">Generate Test Ideas</button>
            </div>
          </div>

          <!-- Source Filter Tabs -->
          <div class="source-filter-tabs" style="display:flex;gap:6px;margin-bottom:16px;">
            <button class="source-filter-btn active" data-source="all" onclick="filterTestsBySource('all', this)">
              <span class="filter-icon">📊</span> All
            </button>
            <button class="source-filter-btn" data-source="facebook_data" onclick="filterTestsBySource('facebook_data', this)">
              <span class="filter-icon">📘</span> FB Data
            </button>
            <button class="source-filter-btn" data-source="reddit" onclick="filterTestsBySource('reddit', this)">
              <span class="filter-icon">🔴</span> Reddit
            </button>
            <button class="source-filter-btn" data-source="tiktok" onclick="filterTestsBySource('tiktok', this)">
              <span class="filter-icon">📱</span> TikTok
            </button>
            <button class="source-filter-btn" data-source="trend" onclick="filterTestsBySource('trend', this)">
              <span class="filter-icon">📈</span> Trends
            </button>
          </div>

          <div id="testSuggestionsLoading" class="loading" style="display:none;"><div class="spinner"></div><br>Analyzing winning videos + researching Reddit + industry trends...</div>
          <div id="testSuggestionsGrid" class="test-suggestions-grid"></div>
        </div>

        <!-- Step 2: Custom Static Generator (Collapsible) -->
        <div class="gen-step collapsible-section">
          <div class="collapsible-header" onclick="toggleCustomGenerator()">
            <h3 style="margin:0;display:flex;align-items:center;gap:8px;">
              <span class="step-num">2</span> Custom Static Generator
              <span style="font-size:12px;color:var(--text-muted);font-weight:400;">(optional)</span>
            </h3>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:12px;color:var(--text-dim);">Create your own statics without a test</span>
              <svg id="customGenChevron" style="width:20px;height:20px;color:var(--text-dim);transition:transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
          </div>
          <div class="collapsible-content" id="customGenContent" style="display:none;">
        <div class="setup-panel" id="genSetupPanel">
          <div class="card">
            <!-- Category (auto-detected from brand) -->
            <div class="brand-category-label" id="brandCategoryLabel" style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px 14px;background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);border-radius:8px;width:fit-content;">
              <span style="font-size:12px;color:var(--text-muted);">Category:</span>
              <span id="brandCategoryValue" style="font-size:13px;font-weight:600;color:var(--accent);text-transform:capitalize;">Apparel</span>
            </div>

            <!-- Apparel Types -->
            <div id="genApparelTypes">
              <div class="card-title">Static Ad Types (select multiple)</div>
              <div class="type-grid static-grid">
                <button class="type-btn selected" data-static="type1" onclick="toggleGenType(this,'apparel')"><span class="name">Product Hero</span><span class="desc">Clean product focus</span></button>
                <button class="type-btn" data-static="type2" onclick="toggleGenType(this,'apparel')"><span class="name">Meme Static</span><span class="desc">Viral meme format</span></button>
                <button class="type-btn" data-static="type3" onclick="toggleGenType(this,'apparel')"><span class="name">Aesthetic Offer</span><span class="desc">Lifestyle + promo</span></button>
                <button class="type-btn" data-static="type4" onclick="toggleGenType(this,'apparel')"><span class="name">Illustrated</span><span class="desc">Hand-drawn style</span></button>
                <button class="type-btn" data-static="type5" onclick="toggleGenType(this,'apparel')"><span class="name">Vintage Magazine</span><span class="desc">Retro editorial</span></button>
                <button class="type-btn" data-static="type6" onclick="toggleGenType(this,'apparel')"><span class="name">UGC Caption</span><span class="desc">Model + handwritten text</span></button>
              </div>
              <div style="margin-top:16px;">
                <label style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:8px;">Variants per type (different angles)</label>
                <div class="variant-selector" style="display:flex;gap:8px;">
                  <button class="gen-var-btn" data-variants="1" onclick="setGenVariants(1,this)">1</button>
                  <button class="gen-var-btn selected" data-variants="2" onclick="setGenVariants(2,this)">2</button>
                  <button class="gen-var-btn" data-variants="3" onclick="setGenVariants(3,this)">3</button>
                  <button class="gen-var-btn" data-variants="4" onclick="setGenVariants(4,this)">4</button>
                </div>
              </div>
            </div>

            <!-- Supplements Types -->
            <div id="genSupplementsTypes" style="display:none;">
              <div class="card-title">Static Ad Types (select multiple)</div>
              <div class="type-grid" style="grid-template-columns:repeat(2,1fr);">
                <button class="type-btn selected" data-static="supp-benefit-checklist" onclick="toggleGenType(this,'supplements')"><span class="name">Benefit Checklist</span><span class="desc">Product + checkmark benefits</span></button>
                <button class="type-btn" data-static="supp-ingredient-halo" onclick="toggleGenType(this,'supplements')"><span class="name">Ingredient Halo</span><span class="desc">Ingredients orbiting product</span></button>
                <button class="type-btn" data-static="supp-illustrated" onclick="toggleGenType(this,'supplements')"><span class="name">Illustrated</span><span class="desc">Bold cartoon/infographic style</span></button>
                <button class="type-btn" data-static="supp-vintage" onclick="toggleGenType(this,'supplements')"><span class="name">Vintage Americana</span><span class="desc">Cinematic nostalgic photography</span></button>
                <button class="type-btn" data-static="supp-minimalist" onclick="toggleGenType(this,'supplements')"><span class="name">Minimalist Hand</span><span class="desc">Hand-drawn, stacked text, clean</span></button>
                <button class="type-btn" data-static="supp-raw-ingredient" onclick="toggleGenType(this,'supplements')"><span class="name">Raw Ingredient</span><span class="desc">Dramatic ingredient hero shot</span></button>
                <button class="type-btn" data-static="supp-meme" onclick="toggleGenType(this,'supplements')"><span class="name">Meme/Cartoon</span><span class="desc">Funny metaphor, shareable</span></button>
              </div>
              <div style="margin-top:16px;">
                <label style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:8px;">Variants per type (different copy angles)</label>
                <div class="variant-selector" style="display:flex;gap:8px;">
                  <button class="gen-var-btn selected" data-variants="1" onclick="setGenVariants(1,this)">1</button>
                  <button class="gen-var-btn" data-variants="2" onclick="setGenVariants(2,this)">2</button>
                  <button class="gen-var-btn" data-variants="3" onclick="setGenVariants(3,this)">3</button>
                  <button class="gen-var-btn" data-variants="4" onclick="setGenVariants(4,this)">4</button>
                </div>
              </div>
            </div>

            <!-- Perfume Types -->
            <div id="genPerfumeTypes" style="display:none;">
              <div class="card-title">Static Ad Types (select multiple)</div>
              <div class="type-grid" style="grid-template-columns:repeat(2,1fr);">
                <button class="type-btn selected" data-static="perf-aesthetic" onclick="toggleGenType(this,'perfume')"><span class="name">Aesthetic Ad</span><span class="desc">Cinematic photo + headline + CTA</span></button>
                <button class="type-btn" data-static="perf-ugc-holding" onclick="toggleGenType(this,'perfume')"><span class="name">UGC Holding</span><span class="desc">Hand holding bottle + quote</span></button>
                <button class="type-btn" data-static="perf-product-hero" onclick="toggleGenType(this,'perfume')"><span class="name">Product Hero</span><span class="desc">Editorial photography, minimal text</span></button>
                <button class="type-btn" data-static="perf-model-closeup" onclick="toggleGenType(this,'perfume')"><span class="name">Model Close-up</span><span class="desc">Person + bottle, intimate</span></button>
                <button class="type-btn" data-static="perf-benefit-callout" onclick="toggleGenType(this,'perfume')"><span class="name">Benefit Callout</span><span class="desc">Benefits + urgency + CTA</span></button>
                <button class="type-btn" data-static="perf-flat-lay" onclick="toggleGenType(this,'perfume')"><span class="name">Flat Lay</span><span class="desc">Products on surface, lifestyle</span></button>
              </div>
              <div style="margin-top:16px;">
                <label style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:8px;">Variants per type (different copy angles)</label>
                <div class="variant-selector" style="display:flex;gap:8px;">
                  <button class="gen-var-btn selected" data-variants="1" onclick="setGenVariants(1,this)">1</button>
                  <button class="gen-var-btn" data-variants="2" onclick="setGenVariants(2,this)">2</button>
                  <button class="gen-var-btn" data-variants="3" onclick="setGenVariants(3,this)">3</button>
                  <button class="gen-var-btn" data-variants="4" onclick="setGenVariants(4,this)">4</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right column: Upload + Launch -->
          <div class="card">
            <div style="display:flex;gap:12px;">
              <div class="upload-box" id="genDropZone" style="flex:1;">
                <img id="genPreview" alt="Preview" style="max-width:100%;max-height:120px;border-radius:8px;display:none;">
                <h3 id="genUploadText" style="font-size:13px;">Product Image</h3>
                <p style="font-size:11px;color:var(--text-muted);">PNG, JPG up to 50MB</p>
                <input type="file" id="genProductImage" accept="image/*" hidden>
              </div>
              <div class="upload-box" id="genLogoDropZone" style="flex:0 0 120px;min-height:100px;">
                <img id="genLogoPreview" alt="Logo" style="max-height:60px;display:none;">
                <h3 id="genLogoText" style="font-size:12px;">Logo (optional)</h3>
                <p style="font-size:10px;color:var(--text-muted);">PNG with transparency</p>
                <input type="file" id="genLogo" accept="image/*" hidden>
              </div>
            </div>
            <div class="url-input">
              <input type="url" id="genUrl" placeholder="Landing page URL">
            </div>
            <div class="url-input" style="margin-top:8px;">
              <input type="text" id="genAngle" placeholder="Angle (auto-fills from selected test, or type your own)">
            </div>
            <button class="launch-btn static-launch" id="genStaticsBtn" onclick="generateStatics()" disabled>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
              Generate Statics
              <span class="count" id="genStaticCount">3 formats</span>
            </button>
          </div>
        </div>
          </div><!-- End collapsible-content -->
        </div><!-- End collapsible-section -->

        <!-- Campaign status bar -->
        <div class="campaign-status" id="genCampaignStatus">
          <div class="status-left">
            <div><span class="status-label">Generation Status</span><br><span class="status-count" id="genProgressText">0 / 0</span></div>
            <div class="progress-bar"><div class="progress-fill" id="genProgressBar" style="width:0%"></div></div>
          </div>
          <button class="download-all" id="genDownloadAll" onclick="downloadAllGen()">Download All (<span id="genCompletedCount">0</span>)</button>
        </div>

        <!-- Image results grid -->
        <div class="image-grid" id="genImageGrid"></div>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="tab-campaigns" class="tab-content">
      <div class="card-header" style="margin-bottom:16px;">
        <h3 style="margin:0;font-size:16px;">Saved Test Campaigns</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="campaignStatusFilter" onchange="loadCampaigns()" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-primary);font-size:12px;">
            <option value="">All Statuses</option>
            <option value="ready">Ready to Launch</option>
            <option value="launched">Launched</option>
            <option value="completed">Completed</option>
            <option value="draft">Drafts</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="loadCampaigns()">Refresh</button>
        </div>
      </div>

      <!-- Campaign Stats -->
      <div id="campaignStats" style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;margin-bottom:20px;">
        <div style="background:var(--bg-card-alt);padding:12px;border-radius:8px;text-align:center;">
          <div style="font-size:20px;font-weight:700;" id="statTotal">0</div>
          <div style="font-size:11px;color:var(--text-muted);">Total Tests</div>
        </div>
        <div style="background:#e8f5e9;padding:12px;border-radius:8px;text-align:center;">
          <div style="font-size:20px;font-weight:700;color:#2e7d32;" id="statReady">0</div>
          <div style="font-size:11px;color:#2e7d32;">Ready</div>
        </div>
        <div style="background:#e3f2fd;padding:12px;border-radius:8px;text-align:center;">
          <div style="font-size:20px;font-weight:700;color:#1976d2;" id="statLaunched">0</div>
          <div style="font-size:11px;color:#1976d2;">Launched</div>
        </div>
        <div style="background:#f3e5f5;padding:12px;border-radius:8px;text-align:center;">
          <div style="font-size:20px;font-weight:700;color:#7b1fa2;" id="statCompleted">0</div>
          <div style="font-size:11px;color:#7b1fa2;">Completed</div>
        </div>
      </div>

      <!-- Campaigns List -->
      <div id="campaignsList" style="display:grid;gap:16px;">
        <div style="text-align:center;padding:40px;color:var(--text-muted);">
          <div style="font-size:32px;margin-bottom:8px;">📋</div>
          <div>No campaigns saved yet.</div>
          <div style="font-size:12px;margin-top:4px;">Generate statics for a test idea and click "Save to Campaign"</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ad Detail Overlay -->
  <div class="ad-detail-overlay" id="adDetailOverlay" onclick="if(event.target===this)closeAdDetail()">
    <div class="ad-detail-panel">
      <button class="ad-detail-close" onclick="closeAdDetail()">&times;</button>
      <div id="adDetailContent"></div>
    </div>
  </div>

  <!-- New Brand Modal -->
  <div id="brandModal" class="modal-overlay">
    <div class="modal-panel">
      <h2>Add Your Brand</h2>
      <div class="modal-subtitle">Set up your brand to start analyzing ad performance</div>

      <label>Brand Name *</label>
      <input type="text" id="modalBrandName" placeholder="e.g. UndrDog">

      <label>Website URL</label>
      <input type="url" id="modalBrandUrl" placeholder="https://yoursite.com">

      <label>Product Category</label>
      <div class="modal-category-grid">
        <button class="modal-cat-btn selected" data-cat="apparel" onclick="selectModalCategory(this)">
          <span class="cat-icon">&#128085;</span>Apparel
        </button>
        <button class="modal-cat-btn" data-cat="supplements" onclick="selectModalCategory(this)">
          <span class="cat-icon">&#128138;</span>Supplements
        </button>
        <button class="modal-cat-btn" data-cat="perfume" onclick="selectModalCategory(this)">
          <span class="cat-icon">&#129526;</span>Perfume
        </button>
        <button class="modal-cat-btn" data-cat="other" onclick="selectModalCategory(this)">
          <span class="cat-icon">&#128230;</span>Other
        </button>
      </div>

      <label style="margin-top:20px;">Performance Goals</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;">
        <div>
          <label style="margin-top:0;">Target ROAS</label>
          <input type="number" id="modalTargetRoas" placeholder="e.g. 2.5" step="0.1" min="0">
        </div>
        <div>
          <label style="margin-top:0;">Target CPA ($)</label>
          <input type="number" id="modalTargetCpa" placeholder="e.g. 30" step="1" min="0">
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:6px;">Used to classify ads as winners/potential/losers. Can be updated later.</div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBrandModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitNewBrand()">Create Brand</button>
      </div>
    </div>
  </div>

  <!-- Brand Settings Modal -->
  <div id="brandSettingsModal" class="modal-overlay" onclick="if(event.target===this)closeBrandSettings()">
    <div class="modal-panel">
      <h2>Brand Settings</h2>
      <div class="modal-subtitle">Update your brand details and performance goals</div>

      <label>Brand Name *</label>
      <input type="text" id="settingsBrandName" placeholder="e.g. UndrDog">

      <label>Website URL</label>
      <input type="url" id="settingsBrandUrl" placeholder="https://yoursite.com">

      <label>Product Image URL</label>
      <input type="url" id="settingsProductImageUrl" placeholder="https://example.com/product.jpg">
      <div style="font-size:11px;color:var(--text-dim);margin-top:4px;margin-bottom:12px;">
        Public URL to your product image. Used as reference for AI static generation. Best results: clean product shot on white/neutral background.
      </div>

      <label>Logo URL</label>
      <input type="url" id="settingsLogoUrl" placeholder="https://example.com/logo.png">
      <div style="font-size:11px;color:var(--text-dim);margin-top:4px;margin-bottom:12px;">
        Public URL to your brand logo. Used in generated statics. Best results: PNG with transparent background.
      </div>

      <label>Product Category</label>
      <div class="modal-category-grid">
        <button class="modal-cat-btn" data-cat="apparel" onclick="selectSettingsCategory(this)">
          <span class="cat-icon">&#128085;</span>Apparel
        </button>
        <button class="modal-cat-btn" data-cat="supplements" onclick="selectSettingsCategory(this)">
          <span class="cat-icon">&#128138;</span>Supplements
        </button>
        <button class="modal-cat-btn" data-cat="perfume" onclick="selectSettingsCategory(this)">
          <span class="cat-icon">&#129526;</span>Perfume
        </button>
        <button class="modal-cat-btn" data-cat="other" onclick="selectSettingsCategory(this)">
          <span class="cat-icon">&#128230;</span>Other
        </button>
      </div>

      <label style="margin-top:20px;">Performance Goals</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;">
        <div>
          <label style="margin-top:0;">Target ROAS</label>
          <input type="number" id="settingsTargetRoas" placeholder="e.g. 2.5" step="0.1" min="0">
        </div>
        <div>
          <label style="margin-top:0;">Target CPA ($)</label>
          <input type="number" id="settingsTargetCpa" placeholder="e.g. 30" step="1" min="0">
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:6px;">Used to classify ads as winners/potential/losers.</div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBrandSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBrandSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    let currentBrandId = null;
    let currentBrandCategory = 'apparel';
    let brandsData = [];
    let currentFilter = 'all';
    let currentSort = 'spend';
    let currentOrder = 'desc';
    let currentOffset = 0;
    let currentView = 'grid';
    let currentAdsData = [];
    // (cachedFbInsights removed — replaced by test suggestions)

    // Generate Statics state
    let genCategory = 'apparel';
    let genApparelTypes = ['type1'];
    let genSuppTypes = ['supp-benefit-checklist'];
    let genPerfTypes = ['perf-aesthetic'];
    let genVariants = 2;
    let genProductFile = null;
    let genLogoFile = null;
    let genTotalImages = 0;
    let genCompleted = 0;
    let genImageCards = {};

    // ═══════════════════════════════════════════
    // Theme Toggle
    // ═══════════════════════════════════════════
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', next);
      document.getElementById('themeLabel').textContent = next === 'light' ? 'Dark mode' : 'Light mode';
      localStorage.setItem('mtrx-theme', next);
    }
    (function initTheme() {
      const saved = localStorage.getItem('mtrx-theme');
      if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        const lbl = document.getElementById('themeLabel');
        if (lbl) lbl.textContent = 'Dark mode';
      }
    })();

    async function init() {
      await loadBrands();
      initGenUploads();
      updateGenCount();
      window.addEventListener('message', (e) => {
        if (e.data?.type === 'fb-auth-success') {
          toast('Facebook connected successfully!', 'success');
          loadConnectionStatus();
        }
      });
    }

    async function loadBrands() {
      try {
        const res = await fetch('/api/auth/facebook/brands');
        brandsData = await res.json();
        const select = document.getElementById('brandSelect');
        select.innerHTML = '<option value="">Select brand...</option>';
        brandsData.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.name + (b.fb_status === 'active' ? ' \u2713' : '');
          select.appendChild(opt);
        });
        if (brandsData.length > 0) {
          select.value = brandsData[0].id;
          switchBrand();
        } else {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('connectionCard').style.display = 'none';
          document.getElementById('dashboard').style.display = 'none';
        }
      } catch (err) {
        console.error('Load brands error:', err);
        document.getElementById('emptyState').style.display = 'block';
      }
    }

    function switchBrand() {
      currentBrandId = document.getElementById('brandSelect').value;
      document.getElementById('brandSettingsBtn').style.display = currentBrandId ? 'inline-block' : 'none';
      if (!currentBrandId) {
        document.getElementById('connectionCard').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('dashboard').style.display = 'none';
        return;
      }
      // Set brand category for Generate Statics tab
      const brand = brandsData.find(b => String(b.id) === String(currentBrandId));
      if (brand?.category) {
        currentBrandCategory = brand.category;
        genCategory = brand.category;
        // Update category label display
        const catLabel = document.getElementById('brandCategoryValue');
        if (catLabel) catLabel.textContent = brand.category.charAt(0).toUpperCase() + brand.category.slice(1);
        // Show correct type grid for this category
        setGenCategory(brand.category);
      }
      cachedTestSuggestions = null; selectedTestIndex = null;
      loadConnectionStatus();
    }

    let modalSelectedCategory = 'apparel';

    function showNewBrandModal() {
      document.getElementById('brandModal').classList.add('show');
      document.getElementById('modalBrandName').value = '';
      document.getElementById('modalBrandUrl').value = '';
      modalSelectedCategory = 'apparel';
      document.querySelectorAll('#brandModal .modal-cat-btn').forEach(b => b.classList.toggle('selected', b.dataset.cat === 'apparel'));
      setTimeout(() => document.getElementById('modalBrandName').focus(), 100);
    }

    function closeBrandModal() {
      document.getElementById('brandModal').classList.remove('show');
    }

    function selectModalCategory(btn) {
      document.querySelectorAll('#brandModal .modal-cat-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      modalSelectedCategory = btn.dataset.cat;
    }

    async function submitNewBrand() {
      const name = document.getElementById('modalBrandName').value.trim();
      const website = document.getElementById('modalBrandUrl').value.trim();
      const targetRoas = parseFloat(document.getElementById('modalTargetRoas').value) || 0;
      const targetCpa = parseFloat(document.getElementById('modalTargetCpa').value) || 0;
      if (!name) { toast('Brand name is required', 'error'); return; }
      try {
        const res = await fetch('/api/auth/facebook/brands', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, websiteUrl: website, category: modalSelectedCategory, targetRoas, targetCpa }),
        });
        const brand = await res.json();
        closeBrandModal();
        toast('Brand created', 'success');
        await loadBrands();
        document.getElementById('brandSelect').value = brand.id;
        switchBrand();
      } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    // ═══════════════════════════════════════════
    // Brand Settings Modal
    // ═══════════════════════════════════════════
    let settingsSelectedCategory = 'apparel';

    function openBrandSettings() {
      const brand = brandsData.find(b => String(b.id) === String(currentBrandId));
      if (!brand) { toast('Select a brand first', 'error'); return; }

      document.getElementById('settingsBrandName').value = brand.name || '';
      document.getElementById('settingsBrandUrl').value = brand.website_url || '';
      document.getElementById('settingsProductImageUrl').value = brand.product_image_url || '';
      document.getElementById('settingsLogoUrl').value = brand.logo_url || '';
      document.getElementById('settingsTargetRoas').value = brand.target_roas || '';
      document.getElementById('settingsTargetCpa').value = brand.target_cpa || '';

      settingsSelectedCategory = brand.category || 'apparel';
      document.querySelectorAll('#brandSettingsModal .modal-cat-btn').forEach(b =>
        b.classList.toggle('selected', b.dataset.cat === settingsSelectedCategory)
      );

      document.getElementById('brandSettingsModal').classList.add('show');
      setTimeout(() => document.getElementById('settingsBrandName').focus(), 100);
    }

    function closeBrandSettings() {
      document.getElementById('brandSettingsModal').classList.remove('show');
    }

    function selectSettingsCategory(btn) {
      document.querySelectorAll('#brandSettingsModal .modal-cat-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      settingsSelectedCategory = btn.dataset.cat;
    }

    async function saveBrandSettings() {
      const name = document.getElementById('settingsBrandName').value.trim();
      if (!name) { toast('Brand name is required', 'error'); return; }

      const payload = {
        name,
        websiteUrl: document.getElementById('settingsBrandUrl').value.trim(),
        productImageUrl: document.getElementById('settingsProductImageUrl').value.trim(),
        logoUrl: document.getElementById('settingsLogoUrl').value.trim(),
        category: settingsSelectedCategory,
        targetRoas: parseFloat(document.getElementById('settingsTargetRoas').value) || 0,
        targetCpa: parseFloat(document.getElementById('settingsTargetCpa').value) || 0,
      };

      try {
        const res = await fetch(`/api/auth/facebook/brands/${currentBrandId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error('Failed to update brand');
        closeBrandSettings();
        toast('Brand settings saved', 'success');
        await loadBrands();
        document.getElementById('brandSelect').value = currentBrandId;
        switchBrand();
      } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    async function loadConnectionStatus() {
      if (!currentBrandId) return;
      try {
        const res = await fetch(`/api/auth/facebook/status/${currentBrandId}`);
        const status = await res.json();
        const card = document.getElementById('connectionCard');
        const statusDiv = document.getElementById('connectionStatus');
        const actionsDiv = document.getElementById('connectionActions');
        card.style.display = 'block';

        if (status.connected) {
          const dotClass = status.status === 'active' ? 'status-active' : 'status-expired';
          statusDiv.innerHTML = `<div class="connection-bar">
            <span><span class="status-dot ${dotClass}"></span>${status.fbUserName}</span>
            <span style="color:#666;">|</span>
            <span style="color:#888;">${status.adAccountName || 'No account selected'}</span>
            <span style="color:#666;">|</span>
            <span style="color:#555;font-size:12px;">Last sync: ${status.lastSyncAt ? new Date(status.lastSyncAt).toLocaleString() : 'Never'}</span>
          </div>`;
          actionsDiv.innerHTML = `<button class="btn btn-danger btn-sm" onclick="disconnectFacebook()">Disconnect</button>`;
          document.getElementById('emptyState').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
          loadDashboard();
        } else {
          statusDiv.innerHTML = `<span><span class="status-dot status-disconnected"></span>Not connected</span>`;
          actionsDiv.innerHTML = `<button class="btn btn-primary btn-sm" onclick="connectFacebook()">Connect</button>`;
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('dashboard').style.display = 'none';
        }
      } catch (err) { console.error('Connection status error:', err); }
    }

    async function connectFacebook() {
      try {
        if (!currentBrandId) {
          const name = prompt('Enter your brand name:');
          if (!name) return;
          const brandRes = await fetch('/api/auth/facebook/brands', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name }),
          });
          const brand = await brandRes.json();
          currentBrandId = brand.id;
          await loadBrands();
          document.getElementById('brandSelect').value = brand.id;
        }
        const res = await fetch('/api/auth/facebook/connect', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ brandId: currentBrandId }),
        });
        const { loginUrl, brandId } = await res.json();
        window.open(loginUrl, 'fbauth', 'width=600,height=700');
      } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    async function disconnectFacebook() {
      if (!confirm('Disconnect Facebook for this brand?')) return;
      try {
        await fetch(`/api/auth/facebook/disconnect/${currentBrandId}`, { method: 'POST' });
        toast('Disconnected', 'success');
        loadConnectionStatus();
      } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    async function loadDashboard() { loadSummary(); loadAds(); loadCampaignStats(); }

    async function loadSummary() {
      try {
        const res = await fetch(`/api/facebook/data/summary/${currentBrandId}`);
        const data = await res.json();
        const winnerCount = data.classifications?.winner || 0;
        const potentialCount = data.classifications?.potential || 0;
        const newCount = data.classifications?.new || 0;

        // Update filter counts
        document.getElementById('filterCountWinner').textContent = winnerCount;
        document.getElementById('filterCountPotential').textContent = potentialCount;
        document.getElementById('filterCountNew').textContent = newCount;
        document.getElementById('filterCountLoser').textContent = data.classifications?.loser || 0;

        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card"><div class="stat-value">${data.totalAds || 0}</div><div class="stat-label">Total Ads</div></div>
          <div class="stat-card"><div class="stat-value">$${(data.totalSpend || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</div><div class="stat-label">Total Spend</div></div>
          <div class="stat-card"><div class="stat-value">${data.totalPurchases || 0}</div><div class="stat-label">Purchases</div></div>
          <div class="stat-card"><div class="stat-value">$${(data.totalRevenue || 0).toLocaleString(undefined, {maximumFractionDigits:0})}</div><div class="stat-label">Revenue</div></div>
          <div class="stat-card"><div class="stat-value">$${(data.avgCpa || 0).toFixed(2)}</div><div class="stat-label">Avg CPA</div></div>
          <div class="stat-card"><div class="stat-value">${(data.avgRoas || 0).toFixed(2)}x</div><div class="stat-label">Avg ROAS</div></div>
          <div class="stat-card cl-stat winner">
            <div class="stat-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="color:#22c55e"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
            <div class="stat-value" style="color:#22c55e">${winnerCount}</div>
            <div class="stat-label">Winners</div>
          </div>
          <div class="stat-card cl-stat potential">
            <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#3b82f6"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg></div>
            <div class="stat-value" style="color:#3b82f6">${potentialCount}</div>
            <div class="stat-label">Potential</div>
          </div>
          <div class="stat-card cl-stat new">
            <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#a855f7"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg></div>
            <div class="stat-value" style="color:#a855f7">${newCount}</div>
            <div class="stat-label">New</div>
          </div>
        `;
      } catch (err) { console.error('Summary error:', err); }
    }

    // ═══════════════════════════════════════════
    // View Toggle
    // ═══════════════════════════════════════════
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-toggle button').forEach(b => b.classList.toggle('active', b.dataset.view === view));
      document.getElementById('adsGridView').style.display = view === 'grid' ? 'grid' : 'none';
      document.getElementById('adsTableView').style.display = view === 'table' ? 'block' : 'none';
    }

    // ═══════════════════════════════════════════
    // Image URL fallback
    // ═══════════════════════════════════════════
    function getAdImageUrl(ad) {
      return ad.image_url || ad.thumbnail_url || '';
    }

    function renderAdImage(ad) {
      const url = getAdImageUrl(ad);
      if (url) {
        return `<img src="${esc(url)}" alt="" onerror="this.parentElement.innerHTML='<span class=\\'placeholder-img\\'>No Preview</span>'">`;
      }
      return '<span class="placeholder-img">No Preview</span>';
    }

    function getClassificationBadge(classification, status) {
      const icons = {
        winner: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
        potential: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>',
        new: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>',
        loser: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/></svg>'
      };
      const labels = { winner: 'Winner', potential: 'Potential', new: 'New', loser: 'Loser' };
      const icon = icons[classification] || '';
      let label = labels[classification] || classification;

      // Show paused indicator
      const isPaused = status === 'PAUSED';
      if (isPaused) {
        label += ' <span style="opacity:0.7;font-size:9px;margin-left:2px;">⏸</span>';
      }

      return `<span class="cl-badge cl-${classification}">${icon}${label}</span>`;
    }

    // ═══════════════════════════════════════════
    // Load & Render Ads
    // ═══════════════════════════════════════════
    async function loadAds() {
      const grid = document.getElementById('adsGridView');
      const tbody = document.getElementById('adsTableBody');
      const loading = document.getElementById('adsLoading');
      loading.style.display = 'block';
      grid.innerHTML = '';
      tbody.innerHTML = '';

      try {
        const params = new URLSearchParams({ sort: currentSort, order: currentOrder, limit: '50', offset: String(currentOffset) });
        if (currentFilter !== 'all') params.set('classification', currentFilter);
        const res = await fetch(`/api/facebook/data/ads/${currentBrandId}?${params}`);
        const { ads, total } = await res.json();
        loading.style.display = 'none';
        currentAdsData = ads;

        if (ads.length === 0) {
          grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No ads found. Sync your data first.</p></div>';
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#555;padding:40px;">No ads found. Sync your data first.</td></tr>';
          return;
        }

        // Render grid cards
        ads.forEach((ad, idx) => {
          const card = document.createElement('div');
          card.className = 'ad-card';
          card.onclick = () => openAdDetail(ad);
          card.innerHTML = `
            <div class="ad-card-image">
              ${renderAdImage(ad)}
              <div class="ad-card-badge">${getClassificationBadge(ad.classification, ad.status)}</div>
              ${ad.video_id ? '<div class="video-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>Video</div>' : ''}
            </div>
            <div class="ad-card-body">
              <div class="ad-card-name" title="${esc(ad.ad_name)}">${esc(ad.ad_name || '')}</div>
              <div class="ad-card-metrics">
                <div class="ad-card-metric"><div class="val">$${ad.spend?.toFixed(0) || '0'}</div><div class="lbl">Spend</div></div>
                <div class="ad-card-metric"><div class="val">$${ad.cpa?.toFixed(2) || '0'}</div><div class="lbl">CPA</div></div>
                <div class="ad-card-metric"><div class="val">${ad.roas?.toFixed(1) || '0'}x</div><div class="lbl">ROAS</div></div>
              </div>
              <div class="ad-card-copy">${esc((ad.body || '').substring(0, 100))}</div>
            </div>`;
          grid.appendChild(card);
        });

        // Render table rows
        ads.forEach(ad => {
          const tr = document.createElement('tr');
          tr.style.cursor = 'pointer';
          tr.onclick = () => openAdDetail(ad);
          tr.innerHTML = `
            <td class="ad-name" title="${esc(ad.ad_name)}">${esc(ad.ad_name || '')}</td>
            <td>${getClassificationBadge(ad.classification, ad.status)}</td>
            <td>$${ad.spend?.toFixed(2) || '0.00'}</td>
            <td>${ad.purchases || 0}</td>
            <td>$${ad.cpa?.toFixed(2) || '0.00'}</td>
            <td>${ad.roas?.toFixed(2) || '0.00'}x</td>
            <td>${ad.ctr?.toFixed(2) || '0.00'}%</td>
            <td>${(ad.impressions || 0).toLocaleString()}</td>
            <td class="ad-copy" title="${esc(ad.body || '')}">${esc((ad.body || '').substring(0, 80))}</td>`;
          tbody.appendChild(tr);
        });

        // Pagination
        const pag = document.getElementById('adsPagination');
        const pages = Math.ceil(total / 50), currentPage = Math.floor(currentOffset / 50) + 1;
        pag.innerHTML = pages > 1 ? `Page ${currentPage} of ${pages} (${total} ads) ${currentPage > 1 ? `<button class="btn btn-secondary btn-sm" onclick="prevPage()">Prev</button>` : ''} ${currentPage < pages ? `<button class="btn btn-secondary btn-sm" onclick="nextPage()">Next</button>` : ''}` : `${total} ads`;
      } catch (err) { loading.style.display = 'none'; toast('Error loading ads: ' + err.message, 'error'); }
    }

    function filterAds(f) { currentFilter = f; currentOffset = 0; document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f)); loadAds(); }
    function sortAds(col) { if (currentSort === col) currentOrder = currentOrder === 'desc' ? 'asc' : 'desc'; else { currentSort = col; currentOrder = 'desc'; } loadAds(); }
    function prevPage() { currentOffset = Math.max(0, currentOffset - 50); loadAds(); }
    function nextPage() { currentOffset += 50; loadAds(); }

    // ═══════════════════════════════════════════
    // Ad Detail Overlay
    // ═══════════════════════════════════════════
    function isVideoAd(ad) {
      return ad.video_id || /\|\s*VID\s*\|/.test(ad.ad_name || '');
    }

    function openAdDetail(ad) {
      const overlay = document.getElementById('adDetailOverlay');
      const content = document.getElementById('adDetailContent');
      const imgUrl = getAdImageUrl(ad);
      const isVideo = isVideoAd(ad);

      // Build media section - video player or image
      let mediaHtml = '';
      if (isVideo && ad.video_id) {
        mediaHtml = `
          <div class="ad-detail-video-container" id="videoContainer">
            <img class="ad-detail-image" src="${esc(imgUrl || '')}" onerror="this.style.display='none'" id="videoThumbnail">
            <div class="video-play-overlay" id="videoPlayBtn" onclick="playAdVideo('${esc(ad.video_id)}', '${esc(ad.fb_ad_id)}')">
              <svg viewBox="0 0 24 24" fill="white" width="64" height="64"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            </div>
          </div>`;
      } else if (imgUrl) {
        mediaHtml = `<img class="ad-detail-image" src="${esc(imgUrl)}" onerror="this.style.display='none'">`;
      }

      content.innerHTML = `
        ${mediaHtml}
        <div class="ad-detail-content">
          <div style="margin-bottom:12px;">${getClassificationBadge(ad.classification, ad.status)}</div>
          <h2>${esc(ad.ad_name || 'Untitled Ad')}</h2>
          ${ad.headline ? `<div class="detail-headline">${esc(ad.headline)}</div>` : ''}

          <div class="ad-detail-metrics">
            <div class="dm"><div class="v">$${ad.spend?.toFixed(2) || '0'}</div><div class="l">Spend</div></div>
            <div class="dm"><div class="v">${ad.purchases || 0}</div><div class="l">Purchases</div></div>
            <div class="dm"><div class="v">$${ad.cpa?.toFixed(2) || '0'}</div><div class="l">CPA</div></div>
            <div class="dm"><div class="v">${ad.roas?.toFixed(2) || '0'}x</div><div class="l">ROAS</div></div>
            <div class="dm"><div class="v">${ad.ctr?.toFixed(2) || '0'}%</div><div class="l">CTR</div></div>
            <div class="dm"><div class="v">${(ad.impressions || 0).toLocaleString()}</div><div class="l">Impressions</div></div>
            <div class="dm"><div class="v">$${ad.cpm?.toFixed(2) || '0'}</div><div class="l">CPM</div></div>
            <div class="dm"><div class="v">$${ad.revenue?.toFixed(0) || '0'}</div><div class="l">Revenue</div></div>
          </div>

          ${isVideo ? `
          <div class="transcript-section">
            <h3>Video Transcript</h3>
            <div id="adDetailTranscript">
              ${ad.video_transcript
                ? `<div class="transcript-content">${esc(ad.video_transcript)}</div>
                   <button class="btn btn-secondary btn-sm" style="margin-top:8px;font-size:11px;" onclick="document.getElementById('transcriptEditArea').style.display='block'">Edit</button>
                   <div id="transcriptEditArea" style="display:none;margin-top:8px;">
                     <textarea id="transcriptInput" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border-hover);border-radius:6px;background:var(--bg-input);color:var(--text-primary);font-family:inherit;font-size:12px;resize:vertical;">${esc(ad.video_transcript)}</textarea>
                     <div style="display:flex;gap:6px;margin-top:6px;">
                       <button class="btn btn-primary btn-sm" onclick="saveTranscript('${esc(ad.fb_ad_id)}')">Save</button>
                       <button class="btn btn-secondary btn-sm" onclick="document.getElementById('transcriptEditArea').style.display='none'">Cancel</button>
                     </div>
                   </div>`
                : `<textarea id="transcriptInput" placeholder="Paste video transcript here..." style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border-hover);border-radius:6px;background:var(--bg-input);color:var(--text-primary);font-family:inherit;font-size:12px;resize:vertical;margin-bottom:8px;"></textarea>
                   <div style="display:flex;gap:6px;">
                     <button class="btn btn-primary btn-sm" onclick="saveTranscript('${esc(ad.fb_ad_id)}')">Save Transcript</button>
                     <button class="transcript-btn" onclick="transcribeVideo('${esc(ad.fb_ad_id)}')" style="font-size:11px;">
                       <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                       Auto-Transcribe
                     </button>
                   </div>`
              }
            </div>
          </div>
          <div class="transcript-section">
            <h3>Video Visual Analysis</h3>
            <div id="adDetailVideoDesc">
              ${ad.video_description
                ? `<div class="video-description-content">${esc(ad.video_description)}</div>`
                : `<button class="transcript-btn" onclick="analyzeVisuals('${esc(ad.fb_ad_id)}')" style="font-size:11px;">
                     <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                     Analyze Visuals
                   </button>
                   <span style="font-size:11px;color:var(--text-dim);margin-left:8px;">Uses Gemini AI to describe what's shown in the video</span>`
              }
            </div>
          </div>` : `${ad.body ? `<div class="ad-detail-copy">${esc(ad.body)}</div>` : ''}`}

          <div class="comments-section">
            <h3>Top Comments</h3>
            <div id="adDetailComments"><div class="comments-loading"><div class="spinner"></div><br>Loading comments...</div></div>
          </div>
        </div>`;

      overlay.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Fetch comments
      loadAdComments(ad.fb_ad_id);
    }

    function closeAdDetail() {
      document.getElementById('adDetailOverlay').classList.remove('show');
      document.body.style.overflow = '';
      // Remove any embedded iframe
      const iframe = document.querySelector('.ad-detail-video-iframe');
      if (iframe) iframe.remove();
    }

    function playAdVideo(videoId, adId) {
      // Create fullscreen video lightbox
      const lightbox = document.createElement('div');
      lightbox.id = 'videoLightbox';
      lightbox.className = 'video-lightbox';
      lightbox.onclick = (e) => { if (e.target === lightbox) closeVideoLightbox(); };

      // Facebook plugin with 9:16 dimensions
      const embedUrl = `https://www.facebook.com/plugins/video.php?height=700&href=https://www.facebook.com/reel/${videoId}&show_text=false&width=394&autoplay=true`;

      lightbox.innerHTML = `
        <button class="video-lightbox-close" onclick="closeVideoLightbox()">×</button>
        <iframe
          src="${embedUrl}"
          class="video-lightbox-iframe"
          allowfullscreen="true"
          allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
        </iframe>
      `;

      document.body.appendChild(lightbox);
      document.body.style.overflow = 'hidden';
    }

    function closeVideoLightbox() {
      const lightbox = document.getElementById('videoLightbox');
      if (lightbox) {
        lightbox.remove();
        document.body.style.overflow = '';
      }
    }

    // Image lightbox for viewing generated statics
    function openImageLightbox(imageUrl, title = '') {
      const lightbox = document.createElement('div');
      lightbox.id = 'imageLightbox';
      lightbox.className = 'video-lightbox';
      lightbox.onclick = (e) => { if (e.target === lightbox) closeImageLightbox(); };

      lightbox.innerHTML = `
        <button class="video-lightbox-close" onclick="closeImageLightbox()">×</button>
        <div style="display:flex;flex-direction:column;align-items:center;gap:16px;max-width:90vw;max-height:90vh;">
          ${title ? `<div style="color:#fff;font-size:14px;font-weight:600;">${esc(title)}</div>` : ''}
          <img src="${esc(imageUrl)}" style="max-width:90vw;max-height:80vh;object-fit:contain;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
          <div style="display:flex;gap:12px;">
            <a href="${esc(imageUrl)}" download style="background:var(--accent);color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-size:13px;font-weight:600;">⬇ Download</a>
            <button onclick="window.open('${esc(imageUrl)}', '_blank')" style="background:var(--bg-input);color:#fff;padding:10px 20px;border-radius:8px;border:1px solid var(--border-hover);font-size:13px;cursor:pointer;">Open in New Tab</button>
          </div>
        </div>
      `;

      document.body.appendChild(lightbox);
      document.body.style.overflow = 'hidden';
    }

    function closeImageLightbox() {
      const lightbox = document.getElementById('imageLightbox');
      if (lightbox) {
        lightbox.remove();
        document.body.style.overflow = '';
      }
    }

    async function loadAdComments(adId) {
      const container = document.getElementById('adDetailComments');
      try {
        const res = await fetch(`/api/facebook/data/comments/${currentBrandId}/${adId}?limit=10`);
        const data = await res.json();

        if (data.error && !data.comments?.length) {
          container.innerHTML = `<div class="comments-error">Could not load comments. The pages_read_engagement permission may not be granted. Disconnect and reconnect Facebook to grant it.</div>`;
          return;
        }

        if (!data.comments || data.comments.length === 0) {
          container.innerHTML = `<div class="comments-error">No comments found on this ad.</div>`;
          return;
        }

        container.innerHTML = `<div class="comments-list">${data.comments.map(c => `
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author">${esc(c.from)}</span>
              <span class="comment-date">${new Date(c.createdTime).toLocaleDateString()}</span>
            </div>
            <div class="comment-body">${esc(c.message)}</div>
            ${c.likeCount > 0 ? `<div class="comment-likes">${c.likeCount} like${c.likeCount !== 1 ? 's' : ''}</div>` : ''}
          </div>`).join('')}</div>`;
      } catch (err) {
        container.innerHTML = `<div class="comments-error">Could not load comments.</div>`;
      }
    }

    async function transcribeVideo(adId) {
      const container = document.getElementById('adDetailTranscript');
      container.innerHTML = '<div class="comments-loading"><div class="spinner"></div><br>Transcribing video... This may take a moment.</div>';
      try {
        const res = await fetch(`/api/facebook/data/transcribe/${currentBrandId}/${adId}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          container.innerHTML = `<div class="transcript-content">${data.transcript ? esc(data.transcript) : '<em style="color:var(--text-dim)">No speech detected in this video.</em>'}</div>`;
          // Auto-trigger visual analysis after transcription
          const descContainer = document.getElementById('adDetailVideoDesc');
          if (descContainer && !descContainer.querySelector('.video-description-content')) {
            analyzeVisuals(adId);
          }
        } else {
          container.innerHTML = `<div class="comments-error">Transcription failed: ${esc(data.error || 'Unknown error')}</div>`;
        }
      } catch (err) {
        container.innerHTML = `<div class="comments-error">Could not transcribe video: ${esc(err.message)}</div>`;
      }
    }

    async function analyzeVisuals(adId) {
      const container = document.getElementById('adDetailVideoDesc');
      container.innerHTML = '<div class="comments-loading"><div class="spinner"></div><br>Analyzing video visuals with Gemini... This may take a moment.</div>';
      try {
        const res = await fetch(`/api/facebook/data/analyze-video/${currentBrandId}/${adId}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          container.innerHTML = `<div class="video-description-content">${esc(data.description)}</div>`;
          // Update local data
          const ad = currentAdsData.find(a => a.fb_ad_id === adId);
          if (ad) ad.video_description = data.description;
        } else {
          container.innerHTML = `<div class="comments-error">Visual analysis failed: ${esc(data.error || 'Unknown error')}</div>`;
        }
      } catch (err) {
        container.innerHTML = `<div class="comments-error">Could not analyze video: ${esc(err.message)}</div>`;
      }
    }

    async function saveTranscript(adId) {
      const text = document.getElementById('transcriptInput').value.trim();
      if (!text) { toast('Paste a transcript first', 'error'); return; }
      try {
        const res = await fetch(`/api/facebook/data/transcript/${currentBrandId}/${adId}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript: text }),
        });
        const data = await res.json();
        if (data.success) {
          toast('Transcript saved', 'success');
          const container = document.getElementById('adDetailTranscript');
          container.innerHTML = `<div class="transcript-content">${esc(text)}</div>`;
          // Update local data
          const ad = currentAdsData.find(a => a.fb_ad_id === adId);
          if (ad) ad.video_transcript = text;
        } else {
          toast('Error: ' + (data.error || 'Unknown'), 'error');
        }
      } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    // Close overlay on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAdDetail();
    });

    // ═══════════════════════════════════════════
    // Sync & Classify (with status banner)
    // ═══════════════════════════════════════════
    function showSyncStatus(text, step) {
      const banner = document.getElementById('syncBanner');
      const textEl = document.getElementById('syncText');
      const stepEl = document.getElementById('syncStep');
      textEl.textContent = text;
      stepEl.textContent = step || '';
      banner.classList.add('active');
    }

    function hideSyncStatus() {
      document.getElementById('syncBanner').classList.remove('active');
    }

    async function syncData() {
      const syncBtn = document.querySelector('[onclick="syncData()"]');
      const classifyBtn = document.querySelector('[onclick="reclassify()"]');
      if (syncBtn) syncBtn.disabled = true;
      if (classifyBtn) classifyBtn.disabled = true;

      const datePreset = document.getElementById('datePresetSelect')?.value || 'last_90d';
      showSyncStatus('Syncing ads from Facebook...', `Step 1 of 2 — Fetching ad data (${datePreset.replace('_', ' ')})`);
      try {
        const res = await fetch(`/api/facebook/data/sync/${currentBrandId}?datePreset=${datePreset}`, { method: 'POST' });
        const summary = await res.json();
        if (summary.error) throw new Error(summary.error);

        showSyncStatus(`Synced ${summary.synced} ads. Now classifying...`, 'Step 2 of 2 — Analyzing performance and classifying ads');
        const classRes = await fetch(`/api/facebook/analysis/classify/${currentBrandId}?datePreset=${datePreset}`, { method: 'POST' });
        const classResult = await classRes.json();

        hideSyncStatus();
        const winners = classResult.classifications?.winner || 0;
        const scalable = classResult.classifications?.scalable || 0;
        toast(`Synced ${summary.synced} ads — ${winners} winners, ${scalable} scalable found`, 'success');
        loadDashboard();
      } catch (err) {
        hideSyncStatus();
        toast('Sync error: ' + err.message, 'error');
      } finally {
        if (syncBtn) syncBtn.disabled = false;
        if (classifyBtn) classifyBtn.disabled = false;
      }
    }

    async function reclassify() {
      const btn = document.querySelector('[onclick="reclassify()"]');
      if (btn) btn.disabled = true;
      const datePreset = document.getElementById('datePresetSelect')?.value || 'last_90d';
      showSyncStatus('Re-classifying ads...', 'Analyzing performance metrics against account benchmarks');
      try {
        const res = await fetch(`/api/facebook/analysis/classify/${currentBrandId}?datePreset=${datePreset}`, { method: 'POST' });
        const result = await res.json();
        hideSyncStatus();
        const winners = result.classifications?.winner || 0;
        toast(`Classified ${result.totalClassified} ads — ${winners} winners found`, 'success');
        loadDashboard();
      } catch (err) {
        hideSyncStatus();
        toast('Classification error: ' + err.message, 'error');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function changeDatePreset() {
      // Re-sync is needed when changing date preset — just notify user
      toast('Time frame changed. Click "Sync Data" to re-fetch with new range.', 'success');
    }

    // ═══════════════════════════════════════════
    // Tab Switching
    // ═══════════════════════════════════════════
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.toggle('active', tc.id === `tab-${tab}`));
      if (tab === 'patterns') loadStrategicInsights();
      if (tab === 'generate') loadCachedTestSuggestions();
      if (tab === 'campaigns') loadCampaigns();
    }

    // ═══════════════════════════════════════════
    // Campaigns Tab
    // ═══════════════════════════════════════════
    async function loadCampaignStats() {
      if (!currentBrandId) return;
      try {
        const res = await fetch(`/api/facebook/campaigns/${currentBrandId}/stats`);
        const data = await res.json();
        if (data.success && data.stats) {
          const s = data.stats;
          document.getElementById('statTotal').textContent = s.total || 0;
          document.getElementById('statReady').textContent = s.ready || 0;
          document.getElementById('statLaunched').textContent = s.launched || 0;
          document.getElementById('statCompleted').textContent = s.completed || 0;
          // Update tab badge
          const badge = document.getElementById('campaignCount');
          if (badge && s.total > 0) {
            badge.textContent = s.total;
            badge.style.display = 'inline';
          }
        }
      } catch (err) { console.error('Campaign stats error:', err); }
    }

    async function loadCampaigns() {
      if (!currentBrandId) return;

      const statusFilter = document.getElementById('campaignStatusFilter')?.value || '';
      const listEl = document.getElementById('campaignsList');

      try {
        const url = statusFilter
          ? `/api/facebook/campaigns/${currentBrandId}?status=${statusFilter}`
          : `/api/facebook/campaigns/${currentBrandId}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          loadCampaignStats();
          renderCampaigns(data.campaigns);
        }
      } catch (err) {
        console.error('Load campaigns error:', err);
        listEl.innerHTML = `<div style="text-align:center;padding:20px;color:#ef4444;">Error loading campaigns</div>`;
      }
    }

    function renderCampaigns(campaigns) {
      const listEl = document.getElementById('campaignsList');

      if (!campaigns || campaigns.length === 0) {
        listEl.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted);">
          <div style="font-size:32px;margin-bottom:8px;">📋</div>
          <div>No campaigns saved yet.</div>
          <div style="font-size:12px;margin-top:4px;">Generate statics for a test idea and click "Save to Campaign"</div>
        </div>`;
        return;
      }

      listEl.innerHTML = campaigns.map(c => {
        const statics = c.statics || [];
        const statusColors = {
          draft: '#6b7280',
          ready: '#22c55e',
          launched: '#3b82f6',
          completed: '#a855f7',
        };
        const statusLabels = {
          draft: 'Draft',
          ready: 'Ready to Launch',
          launched: 'Launched',
          completed: 'Completed',
        };

        return `
          <div class="campaign-card" style="background:var(--bg-card);border:1px solid var(--border-primary);border-radius:12px;overflow:hidden;">
            <div style="display:flex;gap:12px;">
              <!-- Statics thumbnails -->
              <div style="display:flex;gap:4px;padding:12px;background:var(--bg-card-alt);flex-shrink:0;">
                ${statics.slice(0, 3).map(s => `
                  <img src="${esc(s.imageUrl)}" style="width:80px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="openImageLightbox('${esc(s.imageUrl)}', '${esc(s.format || '')}')">
                `).join('')}
                ${statics.length === 0 ? '<div style="width:80px;height:100px;background:#1a1a1a;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#666;font-size:10px;">No statics</div>' : ''}
              </div>

              <!-- Campaign info -->
              <div style="flex:1;padding:12px;display:flex;flex-direction:column;gap:8px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                  <div>
                    <h4 style="margin:0;font-size:14px;font-weight:600;">${esc(c.title)}</h4>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">${esc(c.hook || '')}</div>
                  </div>
                  <span style="background:${statusColors[c.status] || '#6b7280'};color:white;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600;">
                    ${statusLabels[c.status] || c.status}
                  </span>
                </div>

                ${c.angle ? `<div style="font-size:11px;color:var(--text-secondary);"><strong>Angle:</strong> ${esc(c.angle)}</div>` : ''}

                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:auto;">
                  ${(c.recommended_formats || []).map(f => `
                    <span style="background:#e8f5e9;color:#2e7d32;font-size:9px;padding:2px 6px;border-radius:3px;">${esc(f)}</span>
                  `).join('')}
                </div>

                <div style="display:flex;gap:8px;margin-top:8px;">
                  <select onchange="updateCampaignStatus(${c.id}, this.value)" style="padding:4px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border-primary);background:var(--bg-card);">
                    <option value="draft" ${c.status === 'draft' ? 'selected' : ''}>Draft</option>
                    <option value="ready" ${c.status === 'ready' ? 'selected' : ''}>Ready to Launch</option>
                    <option value="launched" ${c.status === 'launched' ? 'selected' : ''}>Launched</option>
                    <option value="completed" ${c.status === 'completed' ? 'selected' : ''}>Completed</option>
                  </select>
                  <button onclick="deleteCampaign(${c.id})" style="padding:4px 8px;font-size:11px;border-radius:4px;border:1px solid #ef4444;background:transparent;color:#ef4444;cursor:pointer;">Delete</button>
                </div>

                <div style="font-size:10px;color:var(--text-faint);margin-top:4px;">
                  Created: ${new Date(c.created_at).toLocaleDateString()}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function updateCampaignStatus(campaignId, status) {
      try {
        const res = await fetch(`/api/facebook/campaigns/${currentBrandId}/${campaignId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        const data = await res.json();
        if (data.success) {
          toast('Status updated', 'success');
          loadCampaignStats();
        }
      } catch (err) {
        toast('Failed to update status', 'error');
      }
    }

    async function deleteCampaign(campaignId) {
      if (!confirm('Delete this campaign? This cannot be undone.')) return;
      try {
        const res = await fetch(`/api/facebook/campaigns/${currentBrandId}/${campaignId}`, {
          method: 'DELETE',
        });
        const data = await res.json();
        if (data.success) {
          toast('Campaign deleted', 'success');
          loadCampaigns();
        }
      } catch (err) {
        toast('Failed to delete campaign', 'error');
      }
    }

    async function loadCachedTestSuggestions() {
      if (cachedTestSuggestions || !currentBrandId) return;
      try {
        const res = await fetch(`/api/facebook/analysis/test-suggestions/${currentBrandId}`);
        const data = await res.json();
        if (data.success && data.suggestions) {
          cachedTestSuggestions = data.suggestions;
          renderTestSuggestions(data.suggestions);
        }
      } catch (err) { /* ignore — user can generate manually */ }
    }

    // ═══════════════════════════════════════════
    // Strategic Insights Tab (Claude-powered)
    // ═══════════════════════════════════════════
    async function loadStrategicInsights() {
      const content = document.getElementById('insightsContent');
      const loading = document.getElementById('insightsLoading');
      const timestamp = document.getElementById('insightsTimestamp');

      // Try to load cached insights first
      try {
        const res = await fetch(`/api/facebook/analysis/strategic-insights/${currentBrandId}`);
        const data = await res.json();
        if (data.success && data.insights) {
          renderInsights(data.insights);
          if (data.insights.generatedAt) {
            timestamp.textContent = `Last analyzed: ${new Date(data.insights.generatedAt).toLocaleString()}`;
          }
          return;
        }
      } catch (err) { /* no cache, show empty state */ }

      content.innerHTML = `<div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-faint)" stroke-width="1.5" style="margin-bottom:16px;"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <h2>No Strategic Analysis Yet</h2>
        <p>Click "Analyze with AI" to have Claude examine your winning ads, audience comments, transcripts, visuals, and creative patterns.</p>
      </div>`;
    }

    async function runStrategicAnalysis() {
      const btn = document.getElementById('runInsightsBtn');
      const loading = document.getElementById('insightsLoading');
      const content = document.getElementById('insightsContent');
      const timestamp = document.getElementById('insightsTimestamp');

      btn.disabled = true;
      loading.style.display = 'block';
      content.innerHTML = '';

      try {
        const res = await fetch(`/api/facebook/analysis/strategic-insights/${currentBrandId}`, { method: 'POST' });
        const data = await res.json();
        loading.style.display = 'none';
        btn.disabled = false;

        if (!data.success) {
          content.innerHTML = `<div class="empty-state"><p>${data.message || 'Could not generate insights.'}</p></div>`;
          return;
        }

        renderInsights(data.insights);
        timestamp.textContent = `Last analyzed: ${new Date(data.insights.generatedAt).toLocaleString()}`;
        toast('Strategic analysis complete', 'success');
      } catch (err) {
        loading.style.display = 'none';
        btn.disabled = false;
        toast('Analysis error: ' + err.message, 'error');
        content.innerHTML = `<div class="empty-state"><p>Error: ${err.message}</p></div>`;
      }
    }

    function renderInsights(insights) {
      const content = document.getElementById('insightsContent');

      if (insights.parseError) {
        content.innerHTML = `<div class="card"><div class="card-title">Raw Analysis</div><div style="font-size:13px;line-height:1.7;color:var(--text-secondary);white-space:pre-wrap;">${esc(insights.raw)}</div></div>`;
        return;
      }

      const sections = [
        { key: 'winningAngles', icon: '1' },
        { key: 'commentInsights', icon: '2' },
        { key: 'creatorAnalysis', icon: '3' },
        { key: 'visualAndFormat', icon: '4' },
        { key: 'iterationIdeas', icon: '5' },
        { key: 'newAngles', icon: '6' },
        { key: 'audienceSignals', icon: '7' },
        { key: 'killAndAvoid', icon: '8' },
      ];

      let html = '';

      // Meta banner — shows breakdown + comment status
      const meta = insights._meta;
      if (meta && meta.totalAdsAnalyzed) {
        let metaText = `Analyzed ${meta.winnersCount || 0} winners + ${meta.potentialCount || 0} potential + ${meta.losersCount || 0} losers`;
        if (meta.commentsFetched && meta.adsWithComments > 0) {
          metaText += ` · Includes comments from ${meta.adsWithComments} ads`;
        } else if (meta.commentsFetched === false) {
          metaText += ` · <span style="color:#f59e0b;">Comments unavailable (token/permissions)</span>`;
        }
        html += `<div style="background:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:8px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          ${metaText}
        </div>`;
      }

      html += '<div class="insights-grid">';

      for (const section of sections) {
        const data = insights[section.key];
        if (!data) continue;

        const confidence = data.confidence || 'medium';
        const details = formatMarkdown(data.details || '');
        const cardId = `insight-${section.key}`;

        html += `<div class="insight-card" id="${cardId}">
          <div class="insight-card-header">
            <div class="insight-card-title">${esc(data.title || section.key)}</div>
            <span class="insight-confidence ${confidence}">${confidence}</span>
          </div>
          <div class="insight-summary">${esc(data.summary || '')}</div>
          <div class="insight-details">${details}</div>
          <button class="insight-expand" onclick="toggleInsight('${cardId}')">Read more</button>
        </div>`;
      }

      html += '</div>';
      content.innerHTML = html;
    }

    function toggleInsight(cardId) {
      const card = document.getElementById(cardId);
      const btn = card.querySelector('.insight-expand');
      card.classList.toggle('expanded');
      btn.textContent = card.classList.contains('expanded') ? 'Show less' : 'Read more';
    }

    // ═══════════════════════════════════════════
    // Generate Statics — Test Suggestions
    // ═══════════════════════════════════════════
    let cachedTestSuggestions = null;
    let selectedTestIndex = null;

    async function loadTestSuggestions(force = false) {
      const btn = document.getElementById('loadTestsBtn');
      const refreshBtn = document.getElementById('refreshTestsBtn');
      const loading = document.getElementById('testSuggestionsLoading');
      const grid = document.getElementById('testSuggestionsGrid');
      btn.disabled = true;
      if (refreshBtn) refreshBtn.disabled = true;
      loading.style.display = 'block';
      grid.innerHTML = '';

      try {
        let res, data;

        if (force) {
          // Force fresh generation with ?force=true
          loading.innerHTML = '<div class="spinner"></div><br>Generating fresh test ideas (checking Reddit, trends, and avoiding already-tested campaigns)...';
          res = await fetch(`/api/facebook/analysis/test-suggestions/${currentBrandId}?force=true`, { method: 'POST' });
          data = await res.json();
        } else {
          // Try cached first
          res = await fetch(`/api/facebook/analysis/test-suggestions/${currentBrandId}`);
          data = await res.json();

          if (!data.success) {
            // Generate fresh
            res = await fetch(`/api/facebook/analysis/test-suggestions/${currentBrandId}`, { method: 'POST' });
            data = await res.json();
          }
        }

        loading.style.display = 'none';
        loading.innerHTML = '<div class="spinner"></div><br>Analyzing winning videos + researching Reddit + industry trends...';
        btn.disabled = false;
        if (refreshBtn) refreshBtn.disabled = false;

        if (!data.success) {
          toast(data.message || 'Could not generate test suggestions', 'error');
          return;
        }

        cachedTestSuggestions = data.suggestions;
        selectedTestIndex = null;
        renderTestSuggestions(data.suggestions);

        if (data.cached) {
          toast('Loaded cached test suggestions. Click Refresh for new ideas.', 'info');
        } else {
          toast('Fresh test suggestions generated!', 'success');
        }
      } catch (err) {
        loading.style.display = 'none';
        loading.innerHTML = '<div class="spinner"></div><br>Analyzing winning videos + researching Reddit + industry trends...';
        btn.disabled = false;
        if (refreshBtn) refreshBtn.disabled = false;
        toast('Error generating tests: ' + err.message, 'error');
      }
    }

    // Force fresh test suggestions (ignores cache)
    async function refreshTestSuggestions() {
      await loadTestSuggestions(true);
    }

    function renderTestSuggestions(suggestions) {
      const grid = document.getElementById('testSuggestionsGrid');
      const tests = suggestions.tests || [];
      const batchAnalysis = suggestions.batch_analysis;

      if (tests.length === 0) {
        grid.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No test suggestions available. Run "Analyze with AI" first, then generate test ideas.</p>';
        return;
      }

      // Limit to top 6 priority tests
      const topTests = tests.slice(0, 6);

      grid.innerHTML = topTests.map((test, i) => {
        const isNew = test.type === 'new_territory';
        const sourceObj = test.source || {};
        const sourceType = typeof sourceObj === 'string' ? sourceObj : sourceObj.type;

        const confidence = test.confidence || {};
        const spendLikelihood = confidence.spend_likelihood || 'medium';
        const learningValue = confidence.learning_value || 'medium';

        const hypothesis = test.hypothesis || {};
        const formats = test.recommended_formats || [];

        // Confidence indicator dots
        const spendDots = spendLikelihood === 'high' ? '●●●' : spendLikelihood === 'low' ? '●○○' : '●●○';
        const learnDots = learningValue === 'high' ? '●●●' : learningValue === 'low' ? '●○○' : '●●○';

        return `
        <div class="test-card-v2" id="test-card-${i}" onclick="selectTest(${i})" data-formats='${JSON.stringify(formats)}' data-source="${sourceType || 'facebook_data'}">
          <!-- Gradient accent bar -->
          <div class="test-card-accent ${isNew ? 'new' : 'iter'}"></div>

          <!-- Main content -->
          <div class="test-card-body">
            <!-- Top badges row -->
            <div class="test-card-badges">
              <span class="test-badge ${isNew ? 'badge-new' : 'badge-iter'}">${isNew ? 'NEW ANGLE' : 'ITERATION'}</span>
              ${sourceType === 'reddit' ? '<span class="test-badge badge-reddit">Reddit</span>' : ''}
              ${sourceType === 'trend' ? '<span class="test-badge badge-trend">Trend</span>' : ''}
              ${sourceType === 'facebook_data' ? '<span class="test-badge badge-fb">FB Data</span>' : ''}
            </div>

            <!-- Hook (the star) -->
            <div class="test-card-hook">"${esc(test.hook)}"</div>

            <!-- Title -->
            <div class="test-card-title">${esc(test.title)}</div>

            <!-- Learning outcome (collapsed) -->
            <div class="test-card-learning">
              ${esc(hypothesis.learning || '').substring(0, 120)}${(hypothesis.learning || '').length > 120 ? '...' : ''}
            </div>

            <!-- Confidence meters -->
            <div class="test-card-meters">
              <div class="meter">
                <span class="meter-label">Spend</span>
                <span class="meter-dots ${spendLikelihood}">${spendDots}</span>
              </div>
              <div class="meter">
                <span class="meter-label">Learn</span>
                <span class="meter-dots ${learningValue}">${learnDots}</span>
              </div>
            </div>

            <!-- Format pills -->
            <div class="test-card-formats">
              ${formats.slice(0, 3).map(f => `<span class="format-pill">${esc(f.replace('_', ' '))}</span>`).join('')}
            </div>

            <!-- Generate button -->
            <button class="test-card-btn" id="genBtn-${i}" onclick="event.stopPropagation(); generateStaticsForTest(${i})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Generate 3 Formats
            </button>

            <!-- Progress area (hidden by default) -->
            <div class="gen-progress" id="genProgress-${i}" style="display:none;margin-top:12px;">
              <div class="gen-progress-items" id="genProgressItems-${i}"></div>
            </div>
          </div>

          <!-- Expandable details (click to show) -->
          <div class="test-card-details" id="details-${i}">
            <div class="detail-row">
              <span class="detail-label">Hypothesis</span>
              <span class="detail-value">${esc(hypothesis.learning || 'N/A')}</span>
            </div>
            ${test.why_untested ? `
            <div class="detail-row">
              <span class="detail-label">Why New</span>
              <span class="detail-value">${esc(test.why_untested)}</span>
            </div>
            ` : ''}
            ${test.iteration_detail ? `
            <div class="detail-row">
              <span class="detail-label">What's Changing</span>
              <span class="detail-value">${esc(test.iteration_detail)}</span>
            </div>
            ` : ''}
            ${sourceObj.evidence ? `
            <div class="detail-row">
              <span class="detail-label">Source</span>
              <span class="detail-value">${esc(sourceObj.evidence)}</span>
            </div>
            ` : ''}
          </div>

          <!-- Expand toggle -->
          <button class="test-card-expand" onclick="event.stopPropagation(); toggleTestDetails(${i})">
            <span id="expand-text-${i}">Show details</span>
            <svg id="expand-icon-${i}" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
        </div>
      `}).join('');
    }

    function toggleTestDetails(index) {
      const details = document.getElementById(`details-${index}`);
      const text = document.getElementById(`expand-text-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);

      if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        text.textContent = 'Show details';
        icon.style.transform = 'rotate(0deg)';
      } else {
        details.classList.add('expanded');
        text.textContent = 'Hide details';
        icon.style.transform = 'rotate(180deg)';
      }
    }

    // Filter tests by source
    let currentSourceFilter = 'all';
    function filterTestsBySource(source, btn) {
      currentSourceFilter = source;

      // Update active state
      document.querySelectorAll('.source-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Remove any existing "no results" message
      const grid = document.getElementById('testSuggestionsGrid');
      const existingNoResults = grid.querySelector('.no-filter-results');
      if (existingNoResults) existingNoResults.remove();

      // Filter the cards
      let visibleCount = 0;
      document.querySelectorAll('.test-card-v2').forEach(card => {
        if (source === 'all') {
          card.style.display = '';
          visibleCount++;
          return;
        }

        // Get the source from data attribute
        const cardSource = card.getAttribute('data-source') || '';
        const matches = cardSource === source;

        card.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });

      // Show message if no results
      if (visibleCount === 0) {
        const sourceLabels = {
          'facebook_data': 'Facebook Ad Data',
          'reddit': 'Reddit',
          'tiktok': 'TikTok',
          'trend': 'Trends'
        };
        const msg = document.createElement('div');
        msg.className = 'no-filter-results';
        msg.style.cssText = 'grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted);font-size:14px;background:var(--bg-card-alt);border-radius:12px;';
        msg.innerHTML = `<div style="font-size:32px;margin-bottom:12px;">🔍</div>No tests from <strong>${sourceLabels[source] || source}</strong>.<br><span style="font-size:12px;color:var(--text-dim);">Try "All" or click Refresh to generate new ideas.</span>`;
        grid.appendChild(msg);
      }
    }

    // Toggle custom generator section
    function toggleCustomGenerator() {
      const content = document.getElementById('customGenContent');
      const chevron = document.getElementById('customGenChevron');
      const section = content.closest('.collapsible-section');

      if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
        section.classList.add('expanded');
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
        section.classList.remove('expanded');
      }
    }

    function selectTest(index) {
      // Deselect all cards
      document.querySelectorAll('.test-card, .test-card-clean, .test-card-v2').forEach(c => {
        c.classList.remove('selected');
        c.style.borderColor = '';
        c.style.boxShadow = '';
      });

      if (selectedTestIndex === index) {
        selectedTestIndex = null;
        document.getElementById('genAngle').value = '';
        return;
      }

      selectedTestIndex = index;
      const card = document.getElementById(`test-card-${index}`);
      if (card) {
        card.classList.add('selected');
        card.style.borderColor = 'var(--accent)';
        card.style.boxShadow = '0 0 0 2px var(--accent), 0 8px 32px rgba(6, 182, 212, 0.2)';
      }

      // Auto-fill angle from selected test
      const test = cachedTestSuggestions?.tests?.[index];
      if (test) {
        const hypothesis = test.hypothesis || {};
        document.getElementById('genAngle').value = test.hook || `${hypothesis.angle || test.angle}`;

        // Auto-select recommended formats if available
        const formats = test.recommended_formats || [];
        if (formats.length > 0) {
          // Map format names to static type IDs
          const formatToType = {
            'product_hero': 'type1',
            'comparison': 'type1', // Use product hero for comparison
            'meme': 'type2',
            'meme_static': 'type2',
            'aesthetic': 'type3',
            'aesthetic_offer': 'type3',
            'illustrated': 'type4',
            'vintage': 'type5',
            'vintage_magazine': 'type5',
            'news_editorial': 'type5', // Use vintage/magazine style
            'ugc': 'type6',
            'ugc_style': 'type6',
            'ugc_caption': 'type6',
            'testimonial': 'type6',
            'before_after': 'type1',
          };

          // Reset all type selections first
          document.querySelectorAll('#genApparelTypes .gen-type-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
          genApparelTypes = [];

          // Select recommended types
          formats.forEach(format => {
            const typeId = formatToType[format.toLowerCase()];
            if (typeId) {
              const btn = document.querySelector(`#genApparelTypes .gen-type-btn[data-static="${typeId}"]`);
              if (btn && !btn.classList.contains('selected')) {
                btn.classList.add('selected');
                if (!genApparelTypes.includes(typeId)) genApparelTypes.push(typeId);
              }
            }
          });

          updateGenCount();
        }
      }
    }

    // ═══════════════════════════════════════════
    // Generate Statics From Test
    // ═══════════════════════════════════════════
    const testRatios = {}; // Track selected ratios per test (now an array)

    function toggleRatio(testIndex, ratio, btn) {
      // Initialize array if needed
      if (!testRatios[testIndex]) {
        testRatios[testIndex] = ['4:5']; // Default
      }

      const idx = testRatios[testIndex].indexOf(ratio);
      if (idx > -1) {
        // Remove if already selected (but keep at least one)
        if (testRatios[testIndex].length > 1) {
          testRatios[testIndex].splice(idx, 1);
          btn.style.background = 'white';
          btn.style.color = '#333';
          btn.classList.remove('selected');
        }
      } else {
        // Add to selection
        testRatios[testIndex].push(ratio);
        btn.style.background = '#17a2b8';
        btn.style.color = 'white';
        btn.classList.add('selected');
      }
    }

    function getSelectedRatios(testIndex) {
      return testRatios[testIndex] || ['4:5'];
    }

    async function generateStaticsForTest(testIndex) {
      const test = cachedTestSuggestions?.tests?.[testIndex];
      if (!test) {
        toast('Test data not found', 'error');
        return;
      }

      const btn = document.getElementById(`genBtn-${testIndex}`);
      const progressContainer = document.getElementById(`genProgress-${testIndex}`);
      const progressItems = document.getElementById(`genProgressItems-${testIndex}`);

      // Format display info (icons and nice names)
      const formatInfo = {
        'product_hero': { name: 'Product Hero', icon: '🖼️' },
        'meme': { name: 'Meme', icon: '😂' },
        'ugc': { name: 'UGC Style', icon: '📱' },
        'aesthetic': { name: 'Aesthetic', icon: '✨' },
        'illustrated': { name: 'Illustrated', icon: '🎨' },
        'vintage': { name: 'Vintage', icon: '📰' },
        'news_editorial': { name: 'News Editorial', icon: '📰' },
        'comparison': { name: 'Comparison', icon: '⚖️' },
        'testimonial': { name: 'Testimonial', icon: '💬' },
        'social_proof': { name: 'Social Proof', icon: '⭐' },
        'lifestyle': { name: 'Lifestyle', icon: '🌿' },
        'benefit_focused': { name: 'Benefits', icon: '✅' },
        'problem_solution': { name: 'Problem/Solution', icon: '💡' },
        'authority': { name: 'Authority', icon: '🏆' },
        'urgency': { name: 'Urgency', icon: '⏰' },
      };

      // Use test's recommended formats, or fall back to defaults
      const testFormats = test.recommended_formats || test.formats || ['product_hero', 'meme', 'ugc'];
      const formats = testFormats.slice(0, 3).map(id => ({
        id,
        name: formatInfo[id]?.name || id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
        icon: formatInfo[id]?.icon || '📷',
      }));

      // Always generate both 4:5 and 9:16 for each format (like image generator)
      const outputRatios = ['4:5', '9:16'];

      // Show progress UI - count is number of formats (each gets both ratios)
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner" style="width:14px;height:14px;border-width:2px;margin-right:8px;"></span>Generating ${formats.length} static${formats.length !== 1 ? 's' : ''}...`;
      progressContainer.style.display = 'block';

      // Initialize progress items (by format - each format generates both ratios)
      progressItems.innerHTML = formats.map((f, i) => `
        <div class="gen-progress-item" id="progress-${testIndex}-${f.id}">
          <div class="progress-icon loading"></div>
          <span class="progress-label">${f.icon} ${f.name} <span style="color:#888;font-size:9px;">(4:5 + 9:16)</span></span>
          <span class="progress-status">Queued...</span>
        </div>
      `).join('');

      // Animate through "generating" states
      let currentIdx = 0;
      const statusInterval = setInterval(() => {
        formats.forEach((f, i) => {
          const item = document.getElementById(`progress-${testIndex}-${f.id}`);
          if (!item) return;
          const status = item.querySelector('.progress-status');
          if (i < currentIdx) {
            status.textContent = 'Generating...';
          } else if (i === currentIdx) {
            item.classList.add('active');
            status.textContent = 'Generating...';
          }
        });
        currentIdx = Math.min(currentIdx + 1, formats.length);
      }, 15000); // Update every 15s

      // Mark first as active immediately
      if (formats.length > 0) {
        const firstItem = document.getElementById(`progress-${testIndex}-${formats[0].id}`);
        if (firstItem) {
          firstItem.classList.add('active');
          firstItem.querySelector('.progress-status').textContent = 'Generating...';
        }
      }

      try {
        const requestData = {
          brandId: currentBrandId,
          test: {
            title: test.title,
            hook: test.hook,
            angle: test.hypothesis?.angle || test.angle || test.title,
            copyDirection: test.hypothesis?.copy_direction || test.copy_direction || '',
            visualDirection: test.hypothesis?.visual_direction || test.visual_direction || '',
            persona: test.persona?.id || test.persona || 'general',
            formats: test.recommended_formats || ['product_hero', 'meme', 'ugc'],
          },
          aspectRatios: outputRatios, // Always both 4:5 and 9:16
          variants: 2,
        };

        const res = await fetch(`/api/facebook/analysis/generate-test-statics/${currentBrandId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData),
        });

        clearInterval(statusInterval);
        const data = await res.json();

        // Update progress items with results - group by format
        if (data.statics) {
          // Group results by format
          const resultsByFormat = {};
          data.statics.forEach(s => {
            const formatId = s.format;
            if (!resultsByFormat[formatId]) resultsByFormat[formatId] = [];
            resultsByFormat[formatId].push(s);
          });

          // Update each format's progress item
          formats.forEach(f => {
            const item = document.getElementById(`progress-${testIndex}-${f.id}`);
            if (!item) return;

            const formatResults = resultsByFormat[f.id] || [];
            const successResults = formatResults.filter(r => r.status === 'complete' && r.imageUrl);

            item.classList.remove('active');
            const icon = item.querySelector('.progress-icon');
            const status = item.querySelector('.progress-status');

            if (successResults.length > 0) {
              icon.className = 'progress-icon done';
              icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
              // Show both ratio thumbnails
              status.innerHTML = successResults.map(r =>
                `<img src="${r.imageUrl}" class="preview-thumb" title="${r.aspectRatio}" onclick="event.stopPropagation(); openImageLightbox('${r.imageUrl}', '${r.aspectRatio}')" style="margin-left:4px;">`
              ).join('');
            } else {
              icon.className = 'progress-icon error';
              icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>';
              status.textContent = formatResults[0]?.error || 'Failed';
            }
          });
        }

        if (data.success) {
          btn.innerHTML = '✓ Generated!';
          btn.style.background = '#22c55e';
          const formatCount = formats.length;
          const imageCount = data.staticsCount || data.statics?.filter(s => s.imageUrl).length || 0;
          toast(`Generated ${formatCount} static${formatCount !== 1 ? 's' : ''} (${imageCount} images) for "${test.title}"`, 'success');

          // Add "View All" button to the card instead of auto-popup
          if (data.statics?.some(s => s.imageUrl)) {
            const card = btn.closest('.test-card-v2');
            if (card) {
              // Store data on the card for later viewing
              card._generatedStatics = data.statics;
              card._testData = test;
              card._campaignCode = data.campaignCode;

              // Add view all button if not already there
              let viewBtn = card.querySelector('.view-all-btn');
              if (!viewBtn) {
                viewBtn = document.createElement('button');
                viewBtn.className = 'view-all-btn';
                viewBtn.style.cssText = 'width:100%;padding:10px;background:var(--bg-input);border:1px solid var(--border-hover);border-radius:8px;color:var(--text-primary);font-size:12px;font-weight:600;cursor:pointer;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:6px;';
                viewBtn.innerHTML = '🖼 View All &amp; Download';
                viewBtn.onclick = () => showGeneratedStatics(card._generatedStatics, card._testData.title, card._testData, card._campaignCode);
                btn.parentNode.appendChild(viewBtn);
              }
            }
          }
        } else {
          btn.innerHTML = '✗ Failed';
          btn.style.background = '#ef4444';
          toast(data.error || 'Failed to generate statics', 'error');
        }
      } catch (err) {
        clearInterval(statusInterval);
        console.error('Generate statics error:', err);
        toast('Error: ' + err.message, 'error');
        btn.innerHTML = '✗ Error';
        btn.style.background = '#ef4444';
      }

      // Reset button after delay
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'Generate Statics for This Test';
        btn.style.background = '';
      }, 5000);
    }

    function showGeneratedStatics(statics, testTitle, testData = null, campaignCode = null) {
      // Create a modal with ratio toggle like image generator
      const modal = document.createElement('div');
      modal.className = 'video-lightbox';
      modal.id = 'staticsModal';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      // Group statics by format
      const byFormat = {};
      statics.forEach(s => {
        if (!byFormat[s.format]) byFormat[s.format] = {};
        byFormat[s.format][s.aspectRatio || '4:5'] = s;
        byFormat[s.format].type = s.type;
        byFormat[s.format].description = s.description;
      });

      const formats = Object.keys(byFormat);

      // Store for toggle functionality
      window._staticsGalleryData = { byFormat, formats, currentRatio: '4:5' };
      window._currentCampaignCode = campaignCode;

      modal.innerHTML = `
        <div style="background:var(--bg-card);border-radius:16px;max-width:95vw;width:fit-content;max-height:90vh;overflow-y:auto;padding:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:20px;flex-wrap:wrap;">
            <div>
              <h2 style="margin:0;font-size:18px;">Generated Statics: ${esc(testTitle)}</h2>
              ${campaignCode ? `<div style="font-size:12px;color:var(--accent);margin-top:4px;">Campaign: <code style="background:var(--accent-bg);padding:2px 6px;border-radius:4px;">${esc(campaignCode)}</code> — Use this code to track ad performance</div>` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button onclick="downloadAllStatics()" style="background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;">⬇ Download All</button>
              <button id="saveToCampaignBtn" onclick="saveToCampaign()" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;">💾 Save to Campaign</button>
              <button onclick="document.getElementById('staticsModal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">×</button>
            </div>
          </div>

          <!-- Ratio Toggle (matches image generator style) -->
          <div style="display:flex;justify-content:center;gap:4px;margin-bottom:20px;">
            <button id="ratioBtn-4:5" onclick="toggleGalleryRatio('4:5')" style="background:#7f78c5;border:1px solid #7f78c5;border-radius:6px;padding:6px 12px;color:#fff;font-size:11px;cursor:pointer;font-weight:600;transition:all 0.15s;">4:5</button>
            <button id="ratioBtn-9:16" onclick="toggleGalleryRatio('9:16')" style="background:#1a1a1a;border:1px solid #333;border-radius:6px;padding:6px 12px;color:#888;font-size:11px;cursor:pointer;font-weight:500;transition:all 0.15s;">9:16</button>
          </div>

          <div id="staticsGalleryGrid" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
            ${renderGalleryForRatio('4:5', byFormat, formats)}
          </div>
        </div>
      `;

      // Store statics and test data for save/download
      window._generatedStatics = statics;
      window._currentTestData = testData;
      document.body.appendChild(modal);
    }

    function renderGalleryForRatio(ratio, byFormat, formats) {
      return formats.map(formatId => {
        const formatData = byFormat[formatId];
        const s = formatData[ratio];
        if (!s) return '';

        return `
          <div style="background:var(--bg-card-alt);border:1px solid var(--border-primary);border-radius:12px;overflow:hidden;max-width:320px;flex-shrink:0;">
            ${s.imageUrl
              ? `<div onclick="openImageLightbox('${esc(s.imageUrl)}', '${esc(formatData.type || formatId)}')" style="display:block;cursor:pointer;">
                  <img src="${esc(s.imageUrl)}" style="width:100%;height:auto;display:block;" title="Click to view full size">
                </div>`
              : `<div style="width:280px;height:350px;background:#1a1a1a;display:flex;align-items:center;justify-content:center;color:#666;">Failed to generate</div>`}
            <div style="padding:12px;">
              ${s.adName ? `<div style="font-size:10px;font-family:monospace;color:var(--accent);margin-bottom:8px;background:var(--accent-bg);padding:4px 8px;border-radius:4px;word-break:break-all;">${esc(s.adName)}</div>` : ''}
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-size:12px;font-weight:600;margin-bottom:4px;">${esc(formatData.type || formatId)}</div>
                  <div style="font-size:11px;color:var(--text-muted);">${esc(formatData.description || '')}</div>
                </div>
                ${s.imageUrl ? `<a href="${esc(s.imageUrl)}" download="${s.adName ? esc(s.adName) + '.png' : ''}" style="background:#333;color:white;padding:6px 10px;border-radius:6px;font-size:11px;text-decoration:none;">⬇</a>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleGalleryRatio(ratio) {
      const data = window._staticsGalleryData;
      if (!data) return;

      data.currentRatio = ratio;

      // Update buttons to match image generator style
      const btn45 = document.getElementById('ratioBtn-4:5');
      const btn916 = document.getElementById('ratioBtn-9:16');

      if (ratio === '4:5') {
        btn45.style.background = '#7f78c5';
        btn45.style.borderColor = '#7f78c5';
        btn45.style.color = '#fff';
        btn45.style.fontWeight = '600';
        btn916.style.background = '#1a1a1a';
        btn916.style.borderColor = '#333';
        btn916.style.color = '#888';
        btn916.style.fontWeight = '500';
      } else {
        btn916.style.background = '#7f78c5';
        btn916.style.borderColor = '#7f78c5';
        btn916.style.color = '#fff';
        btn916.style.fontWeight = '600';
        btn45.style.background = '#1a1a1a';
        btn45.style.borderColor = '#333';
        btn45.style.color = '#888';
        btn45.style.fontWeight = '500';
      }

      // Update gallery
      document.getElementById('staticsGalleryGrid').innerHTML = renderGalleryForRatio(ratio, data.byFormat, data.formats);
    }

    async function saveToCampaign() {
      const statics = window._generatedStatics || [];
      const testData = window._currentTestData;

      if (!testData) {
        toast('No test data to save', 'error');
        return;
      }

      const btn = document.getElementById('saveToCampaignBtn');
      btn.disabled = true;
      btn.innerHTML = '💾 Saving...';

      try {
        const res = await fetch(`/api/facebook/campaigns/${currentBrandId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: testData.title,
            hook: testData.hook,
            angle: testData.angle,
            hypothesis: testData.hypothesis?.angle || testData.angle,
            copyDirection: testData.hypothesis?.copy_direction || testData.copy_direction,
            visualDirection: testData.hypothesis?.visual_direction || testData.visual_direction,
            priority: testData.priority,
            rationale: testData.rationale,
            basedOn: testData.based_on,
            recommendedFormats: testData.recommended_formats,
            statics: statics.filter(s => s.imageUrl).map(s => ({
              type: s.type,
              format: s.format,
              aspectRatio: s.aspectRatio || '4:5',
              imageUrl: s.imageUrl,
              description: s.description,
            })),
            status: 'ready',
          }),
        });

        const data = await res.json();
        if (data.success) {
          btn.innerHTML = '✅ Saved!';
          btn.style.background = '#218838';
          toast('Saved to campaigns!', 'success');
          // Refresh campaigns count if visible
          loadCampaignStats();
        } else {
          throw new Error(data.error || 'Save failed');
        }
      } catch (err) {
        console.error('Save campaign error:', err);
        btn.disabled = false;
        btn.innerHTML = '💾 Save to Campaign';
        toast('Failed to save: ' + err.message, 'error');
      }
    }

    async function downloadAllStatics() {
      const statics = window._generatedStatics || [];
      for (const s of statics) {
        if (s.imageUrl) {
          const a = document.createElement('a');
          a.href = s.imageUrl;
          a.download = `${(s.type || 'static').replace(/\s+/g, '-').toLowerCase()}.png`;
          a.click();
          await new Promise(r => setTimeout(r, 500)); // Small delay between downloads
        }
      }
    }

    // ═══════════════════════════════════════════
    // Generate Statics — Category / Type / Variant
    // ═══════════════════════════════════════════
    function setGenCategory(cat) {
      genCategory = cat;
      document.getElementById('genApparelTypes').style.display = cat === 'apparel' ? 'block' : 'none';
      document.getElementById('genSupplementsTypes').style.display = cat === 'supplements' ? 'block' : 'none';
      document.getElementById('genPerfumeTypes').style.display = cat === 'perfume' ? 'block' : 'none';
      if (cat === 'supplements') genVariants = 1;
      else if (cat === 'perfume') genVariants = 1;
      else genVariants = 2;
      updateGenCount();
    }

    function toggleGenType(btn, cat) {
      btn.classList.toggle('selected');
      const type = btn.dataset.static;
      let arr = cat === 'apparel' ? genApparelTypes : cat === 'supplements' ? genSuppTypes : genPerfTypes;
      if (btn.classList.contains('selected')) {
        if (!arr.includes(type)) arr.push(type);
      } else {
        const idx = arr.indexOf(type); if (idx > -1) arr.splice(idx, 1);
      }
      updateGenCount();
    }

    function setGenVariants(n, btn) {
      genVariants = n;
      btn.parentElement.querySelectorAll('.gen-var-btn').forEach(b => {
        b.classList.toggle('selected', parseInt(b.dataset.variants) === n);
      });
      updateGenCount();
    }

    function getSelectedGenTypes() {
      if (genCategory === 'apparel') return genApparelTypes;
      if (genCategory === 'supplements') return genSuppTypes;
      return genPerfTypes;
    }

    function updateGenCount() {
      const total = getSelectedGenTypes().length * genVariants;
      document.getElementById('genStaticCount').textContent = total + (total === 1 ? ' static' : ' statics');
      updateGenLaunchBtn();
    }

    function updateGenLaunchBtn() {
      const btn = document.getElementById('genStaticsBtn');
      const url = document.getElementById('genUrl')?.value;
      btn.disabled = !genProductFile || !url || getSelectedGenTypes().length === 0;
    }

    // ═══════════════════════════════════════════
    // Generate Statics — Upload Handling
    // ═══════════════════════════════════════════
    function initGenUploads() {
      const dropZone = document.getElementById('genDropZone');
      const imageInput = document.getElementById('genProductImage');
      const logoDropZone = document.getElementById('genLogoDropZone');
      const logoInput = document.getElementById('genLogo');
      const urlInput = document.getElementById('genUrl');

      if (!dropZone) return;

      dropZone.addEventListener('click', () => imageInput.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
      dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = ''; });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = ''; if (e.dataTransfer.files[0]) handleGenFile(e.dataTransfer.files[0]); });
      imageInput.addEventListener('change', () => { if (imageInput.files[0]) handleGenFile(imageInput.files[0]); });

      logoDropZone.addEventListener('click', () => logoInput.click());
      logoDropZone.addEventListener('dragover', (e) => { e.preventDefault(); logoDropZone.style.borderColor = 'var(--accent)'; });
      logoDropZone.addEventListener('dragleave', () => { logoDropZone.style.borderColor = ''; });
      logoDropZone.addEventListener('drop', (e) => { e.preventDefault(); logoDropZone.style.borderColor = ''; if (e.dataTransfer.files[0]) handleGenLogo(e.dataTransfer.files[0]); });
      logoInput.addEventListener('change', () => { if (logoInput.files[0]) handleGenLogo(logoInput.files[0]); });

      urlInput.addEventListener('input', updateGenLaunchBtn);
    }

    function handleGenFile(file) {
      genProductFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('genPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('genUploadText').style.display = 'none';
        document.getElementById('genDropZone').querySelector('p').style.display = 'none';
        document.getElementById('genDropZone').classList.add('has-file');
      };
      reader.readAsDataURL(file);
      updateGenLaunchBtn();
    }

    function handleGenLogo(file) {
      genLogoFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('genLogoPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('genLogoText').style.display = 'none';
        document.getElementById('genLogoDropZone').querySelector('p').style.display = 'none';
        document.getElementById('genLogoDropZone').classList.add('has-file');
      };
      reader.readAsDataURL(file);
    }

    // ═══════════════════════════════════════════
    // Generate Statics — Launch
    // ═══════════════════════════════════════════
    async function generateStatics() {
      const btn = document.getElementById('genStaticsBtn');
      const url = document.getElementById('genUrl').value;
      const angleOverride = document.getElementById('genAngle').value;
      const grid = document.getElementById('genImageGrid');
      const statusBar = document.getElementById('genCampaignStatus');

      if (!genProductFile) { toast('Please upload a product image', 'error'); return; }
      if (!url) { toast('Please enter a website URL', 'error'); return; }

      btn.disabled = true;
      grid.innerHTML = '';
      genCompleted = 0;
      genImageCards = {};

      const selectedTypes = getSelectedGenTypes();
      genTotalImages = selectedTypes.length * genVariants;

      // Show campaign status
      statusBar.classList.add('active');
      document.getElementById('genProgressText').textContent = `0 / ${genTotalImages}`;
      document.getElementById('genProgressBar').style.width = '0%';
      document.getElementById('genCompletedCount').textContent = '0';

      // Create placeholder cards
      for (let i = 0; i < genTotalImages; i++) {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.id = `gen-card-${i}`;
        card.innerHTML = `<div class="image-placeholder"><div class="spinner"></div><span class="status-text queue">QUEUE</span></div>`;
        grid.appendChild(card);
        genImageCards[i] = card;
      }

      // Build form data
      const formData = new FormData();
      formData.append('image', genProductFile);
      if (genLogoFile) formData.append('logo', genLogoFile);
      formData.append('url', url);
      formData.append('category', genCategory);
      formData.append('campaignId', 'fb-gen-' + Date.now());
      formData.append('variantsPerType', String(genVariants));
      formData.append('staticTypes', JSON.stringify(selectedTypes));

      // Use angle override (which may be auto-filled from a selected test)
      const selectedTest = selectedTestIndex != null ? cachedTestSuggestions?.tests?.[selectedTestIndex] : null;
      const angle = angleOverride || '';
      if (angle) formData.append('angle', angle);
      if (selectedTest) {
        formData.append('fbInsights', JSON.stringify({
          proposedAngle: selectedTest.angle,
          copyDirection: selectedTest.copyDirection,
          hook: selectedTest.hook,
          format: selectedTest.format,
        }));
      }

      try {
        const response = await fetch('/generate-statics', { method: 'POST', body: formData });
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            try {
              const evt = JSON.parse(line.substring(6));
              if (evt.type === 'start' && genImageCards[evt.id]) {
                genImageCards[evt.id].classList.add('forging');
                const st = genImageCards[evt.id].querySelector('.status-text');
                if (st) { st.textContent = 'FORGING'; st.className = 'status-text forging'; }
              } else if (evt.type === 'complete' || (evt.type === 'image' && evt.url)) {
                const id = evt.id != null ? evt.id : genCompleted;
                const card = genImageCards[id];
                if (card) {
                  card.classList.remove('forging');
                  const imgUrl = evt.url;
                  card.innerHTML = `
                    <img src="${esc(imgUrl)}" alt="Generated">
                    <div class="info">
                      <div class="direction">${esc(evt.direction || '')}</div>
                      <div class="type-badge">${esc(evt.imageType || 'STATIC')}</div>
                      <div class="actions">
                        <a href="${esc(imgUrl)}" target="_blank" class="view-btn">View</a>
                        <button class="download-btn" onclick="downloadGenImage('${esc(imgUrl)}','${esc(evt.direction || 'static')}.png')">Download</button>
                      </div>
                    </div>`;
                }
                genCompleted++;
                document.getElementById('genProgressText').textContent = `${genCompleted} / ${genTotalImages}`;
                document.getElementById('genProgressBar').style.width = (genCompleted / genTotalImages * 100) + '%';
                document.getElementById('genCompletedCount').textContent = String(genCompleted);
              } else if (evt.type === 'error') {
                const id = evt.id != null ? evt.id : genCompleted;
                const card = genImageCards[id];
                if (card) {
                  card.classList.remove('forging');
                  card.classList.add('error');
                  card.innerHTML = `<div class="image-placeholder"><span class="status-text" style="color:#ef4444;">FAILED</span><div class="error-msg">${esc(evt.error || 'Unknown error')}</div></div>`;
                }
                genCompleted++;
                document.getElementById('genProgressText').textContent = `${genCompleted} / ${genTotalImages}`;
                document.getElementById('genProgressBar').style.width = (genCompleted / genTotalImages * 100) + '%';
              }
            } catch (e) { /* skip non-JSON */ }
          }
        }

        btn.disabled = false;
        if (genCompleted > 0) toast(`Generated ${genCompleted} statics!`, 'success');
      } catch (err) {
        btn.disabled = false;
        toast('Generation error: ' + err.message, 'error');
      }
    }

    function downloadGenImage(url, filename) {
      fetch(url).then(r => r.blob()).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    function downloadAllGen() {
      document.querySelectorAll('#genImageGrid .image-card img').forEach((img, i) => {
        if (img.src) downloadGenImage(img.src, `static-${i + 1}.png`);
      });
    }

    // ═══════════════════════════════════════════
    // Utilities
    // ═══════════════════════════════════════════
    function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
    function formatMarkdown(text) { if (!text) return ''; return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n- /g, '\n<li>').replace(/\n\d+\.\s/g, '\n<li>').replace(/<li>/g, '</li><li>').replace(/\n/g, '<br>').replace(/^/, '<div>').replace(/$/, '</div>'); }
    function toast(msg, type = '') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.className = 'toast', 3000); }

    init();
  </script>
</body>
</html>
